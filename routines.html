<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rutinas de Entrenamiento</title>
    <link rel="icon" type="image/png" href="mini_logo.png">
    <link rel="shortcut icon" type="image/png" href="mini_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Tema de Fondo Minimalista: Base Oscura */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a;
            /* Usamos el mismo fondo del Dashboard (PROFILE_FONDO) */
            background-image: url('PROFILE_FONDO.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #e5e7eb; 
            transition: background-image 1s ease-in-out; 

            /* Borde negro para todas las letras (Text Stroke Effect) */
            text-shadow: 
                -0.5px -0.5px 0 #000,  
                 0.5px -0.5px 0 #000,
                -0.5px  0.5px 0 #000,
                 0.5px  0.5px 0 #000;
        }

        /* Estilo para las Tarjetas de Vidrio (Glassmorphism) */
        .glass-card {
            background-color: rgba(255, 255, 255, 0.05); /* Fondo muy transparente */
            backdrop-filter: blur(10px); /* Efecto de desenfoque */
            -webkit-backdrop-filter: blur(10px); /* Soporte para Safari */
            border-radius: 12px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid; /* El borde que cambia de color */
            transition: all 0.2s ease-in-out;
            transform: scale(1);
        }

        .glass-card:hover {
            box-shadow: 0 6px 40px rgba(250, 192, 40, 0.2);
            transform: scale(1.02);
        }
        
        /* Estilo para la Caja de Mensajes Flotante */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            opacity: 0;
            padding: 10px 20px;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            white-space: nowrap;
        }

        .message-success {
            background-color: #10b981; /* green-500 */
        }
        
        .message-error {
            background-color: #ef4444; /* red-500 */
        }

        /* Utilidad para evitar transición en cambios instantáneos */
        .transition-none {
            transition: none !important;
        }
    </style>
</head>
<body class="min-h-screen">
    <section class="p-4 md:p-8 lg:p-12">
        <h1 class="text-4xl md:text-5xl font-extrabold text-white text-center mb-8 tracking-tighter">
            <span class="text-amber-400">Rutinas</span> Semanales
        </h1>
        
        <div id="message-box" class="message-success"></div>

        <div id="day-cards-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-6 max-w-7xl mx-auto">

            <a href="monday.html" class="glass-card flex flex-col items-center justify-center p-6 space-y-4 hover:border-amber-400 border-amber-400">
                <svg class="dumbbell-svg w-12 h-12" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="15" y="45" width="70" height="10" rx="4" fill="#6b7280" class="bar"/>
                    <rect x="5" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                    <rect x="90" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                </svg>
                <h3 class="text-xl font-bold uppercase tracking-wider text-amber-400 day-name-text">Lunes</h3>
            </a>

            <a href="tuesday.html" class="glass-card flex flex-col items-center justify-center p-6 space-y-4 hover:border-amber-400 border-amber-400">
                <svg class="dumbbell-svg w-12 h-12" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="15" y="45" width="70" height="10" rx="4" fill="#6b7280" class="bar"/>
                    <rect x="5" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                    <rect x="90" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                </svg>
                <h3 class="text-xl font-bold uppercase tracking-wider text-amber-400 day-name-text">Martes</h3>
            </a>
            
            <a href="wednesday.html" class="glass-card flex flex-col items-center justify-center p-6 space-y-4 hover:border-amber-400 border-amber-400">
                <svg class="dumbbell-svg w-12 h-12" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="15" y="45" width="70" height="10" rx="4" fill="#6b7280" class="bar"/>
                    <rect x="5" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                    <rect x="90" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                </svg>
                <h3 class="text-xl font-bold uppercase tracking-wider text-amber-400 day-name-text">Miércoles</h3>
            </a>

            <a href="thursday.html" class="glass-card flex flex-col items-center justify-center p-6 space-y-4 hover:border-amber-400 border-amber-400">
                <svg class="dumbbell-svg w-12 h-12" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="15" y="45" width="70" height="10" rx="4" fill="#6b7280" class="bar"/>
                    <rect x="5" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                    <rect x="90" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                </svg>
                <h3 class="text-xl font-bold uppercase tracking-wider text-amber-400 day-name-text">Jueves</h3>
            </a>
            
            <a href="friday.html" class="glass-card flex flex-col items-center justify-center p-6 space-y-4 hover:border-amber-400 border-amber-400">
                <svg class="dumbbell-svg w-12 h-12" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="15" y="45" width="70" height="10" rx="4" fill="#6b7280" class="bar"/>
                    <rect x="5" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                    <rect x="90" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                </svg>
                <h3 class="text-xl font-bold uppercase tracking-wider text-amber-400 day-name-text">Viernes</h3>
            </a>

            <a href="saturday.html" class="glass-card flex flex-col items-center justify-center p-6 space-y-4 hover:border-amber-400 border-amber-400">
                <svg class="dumbbell-svg w-12 h-12" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <rect x="15" y="45" width="70" height="10" rx="4" fill="#6b7280" class="bar"/>
                    <rect x="5" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                    <rect x="90" y="35" width="5" height="30" rx="2" fill="#facc15" class="weight"/>
                </svg>
                <h3 class="text-xl font-bold uppercase tracking-wider text-amber-400 day-name-text">Sábado</h3>
            </a>
            
        </div>

    </section>

    <script>
        // --- CONFIGURACIÓN DE ACCESO AL BACKEND (AJUSTAR ESTO EN SU ENTORNO REAL) ---
        // ⚠️ IMPORTANTE: REEMPLAZA ESTAS VARIABLES CON LOS VALORES REALES DE TU APLICACIÓN
        const BACKEND_BASE_URL = "https://tudominio.com/api"; // Ejemplo: "https://gymenez-api.pythonanywhere.com/api"
        const USER_ID = "ID_DEL_USUARIO_ACTUAL"; // Debes obtener este ID al hacer login/cargar la sesión

        // --- Variables y Utilidades Globales ---
        const messagebox = document.getElementById('message-box');
        const ONE_DAY_MS = 24 * 60 * 60 * 1000;
        const SEVEN_DAYS_MS = 7 * ONE_DAY_MS;
        // Objeto que almacenará los datos reales de la última sesión para cada día
        let lastRoutineDates = {}; 

        // Mapeo de días de la semana (1-6) a nombres y URLs (Mantenido)
        const daysMap = {
            1: { name: 'Lunes', url: 'monday.html' },
            2: { name: 'Martes', url: 'tuesday.html' },
            3: { name: 'Miércoles', url: 'wednesday.html' },
            4: { name: 'Jueves', url: 'thursday.html' },
            5: { name: 'Viernes', url: 'friday.html' },
            6: { name: 'Sábado', url: 'saturday.html' }
        };

        // Función para mostrar mensajes de estado (éxito/error) (Sin cambios)
        function showMessage(message, type = 'success') {
            messagebox.textContent = message;
            messagebox.className = ''; 
            messagebox.classList.add('transition-none');
            messagebox.classList.add('message-' + type);
            messagebox.style.opacity = '1';
            messagebox.style.transform = 'translateX(-50%) translateY(0)';
            
            setTimeout(() => {
                messagebox.style.style = '';
                messagebox.style.opacity = '0';
                messagebox.style.transform = 'translateX(-50%) translateY(-20px)';
            }, 3000);
        }
        
        // ====================================================================
        // FUNCIÓN DE CONEXIÓN AL BACKEND
        // ====================================================================

        async function fetchLastRoutineDates() {
            if (USER_ID === "ID_DEL_USUARIO_ACTUAL") {
                console.error("ERROR: Debes configurar el USER_ID real antes de llamar al backend.");
                showMessage("ERROR: ID de usuario no configurado. Rutinas Desbloqueadas.", 'error');
                return true; 
            }
            
            try {
                const url = `${BACKEND_BASE_URL}/journal/last_sessions/${USER_ID}`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    // lastRoutineDates ahora es un objeto como: {'Lunes': 1732152000000, 'Miércoles': 1731633600000}
                    lastRoutineDates = data.lastRoutineDates; 
                    return true;
                } else {
                    console.error("Error al obtener las fechas del journal:", data.error);
                    showMessage("Error al cargar el historial de rutinas.", 'error');
                    return false;
                }
            } catch (error) {
                console.error("Error de red al llamar al backend:", error);
                showMessage("Error de conexión con el servidor. Revisar URL.", 'error');
                return false;
            }
        }

        // ====================================================================
        // LÓGICA DE BLOQUEO/DESBLOQUEO
        // ====================================================================

        /**
         * Verifica el estado de una rutina (Bloqueada, Desbloqueada o Día Actual).
         * @param {number} dayIndex - El índice del día (1=Lunes a 6=Sábado).
         * @param {string} dayName - El nombre del día (e.g., 'Lunes').
         * @returns {'current'|'locked'|'unlocked'} El estado del día.
         */
        function checkRoutineStatus(dayIndex, dayName) {
            const today = new Date();
            const todayIndex = today.getDay(); // 0=Domingo, 1=Lunes, ..., 6=Sábado
            
            // 1. Lógica del Día Actual (Verde)
            if (dayIndex === todayIndex) {
                return 'current';
            }

            // 2. Lógica de Bloqueo (Rojo)
            // lastRoutineDates[dayName] es el timestamp en ms o undefined.
            const lastTimestamp = lastRoutineDates[dayName];
            
            if (lastTimestamp) {
                // Obtenemos la fecha en ms de hace 7 días
                const sevenDaysAgo = today.getTime() - SEVEN_DAYS_MS;

                // Si la última fecha guardada (lastTimestamp) es posterior a la de hace 7 días, está bloqueada.
                if (lastTimestamp > sevenDaysAgo) {
                    return 'locked';
                }
            }

            // 3. Lógica de Desbloqueo (Ámbar por defecto)
            return 'unlocked';
        }

        /**
         * Aplica los estilos y la lógica de bloqueo a las tarjetas de rutina.
         */
        function updateRoutineCards() {
            const dayCardsContainer = document.getElementById('day-cards-container');
            const dayCards = dayCardsContainer.querySelectorAll('.glass-card');
            
            let currentDayFound = false;
            
            dayCards.forEach(card => {
                const dayNameElement = card.querySelector('.day-name-text');
                const dayName = dayNameElement.textContent.trim();
                const originalHref = card.getAttribute('href') || card.getAttribute('data-href');
                const svg = card.querySelector('.dumbbell-svg');

                // Obtener el índice numérico del día (1 a 6)
                const dayEntry = Object.entries(daysMap).find(([key, value]) => value.name === dayName);
                const dayIndex = dayEntry ? parseInt(dayEntry[0]) : null;
                
                if (!dayIndex) return; 

                const status = checkRoutineStatus(dayIndex, dayName);
                
                // Limpiar estilos previos de color
                card.classList.remove('border-amber-400', 'border-red-600', 'border-green-600');
                dayNameElement.classList.remove('text-amber-400', 'text-red-600', 'text-green-600');
                svg.querySelectorAll('.bar, .weight').forEach(el => el.setAttribute('fill', '#facc15')); // Amarillo base
                
                // Aplicar estilos y lógica
                if (status === 'current') {
                    // Estilo Verde (Día Actual)
                    card.classList.add('border-green-600');
                    dayNameElement.classList.add('text-green-600');
                    svg.querySelectorAll('.bar, .weight').forEach(el => el.setAttribute('fill', '#10b981')); // Green
                    card.classList.remove('hover:border-amber-400'); 
                    card.style.cursor = 'pointer';
                    card.classList.remove('opacity-50');
                    if (originalHref) card.setAttribute('href', originalHref);
                    card.onclick = null;
                    currentDayFound = true; 

                } else if (status === 'locked') {
                    // Estilo Rojo (Bloqueado)
                    card.classList.add('border-red-600');
                    dayNameElement.classList.add('text-red-600');
                    card.classList.remove('hover:border-amber-400');
                    card.style.cursor = 'not-allowed'; 
                    card.classList.add('opacity-50'); 
                    
                    // DESHABILITAR el enlace y agregar mensaje
                    if (originalHref) card.setAttribute('data-href', originalHref); // Guarda el href
                    card.removeAttribute('href');
                    card.onclick = (e) => {
                        e.preventDefault();
                        showMessage(`¡Rutina de ${dayName} ya completada! Vuelve en 7 días o el próximo ${dayName}.`, 'error');
                    };
                    
                } else {
                    // Estilo Ámbar por Defecto (Desbloqueado)
                    card.classList.add('border-amber-400');
                    dayNameElement.classList.add('text-amber-400');
                    card.classList.add('hover:border-amber-400');
                    card.style.cursor = 'pointer';
                    card.classList.remove('opacity-50');
                    
                    // Asegurar que el enlace esté presente
                    if (!card.hasAttribute('href') && originalHref) {
                        card.setAttribute('href', originalHref);
                        card.removeAttribute('data-href'); // Limpiar el guardado si existía
                        card.onclick = null;
                    }
                }
            });

            // Mensaje de bienvenida
            if (!currentDayFound) {
                showMessage('¡Hoy es Domingo o un día fuera de la rutina! Selecciona un día desbloqueado.', 'error');
            } else {
                showMessage('Selecciona un día para ver tu rutina. El día de hoy está en verde.', 'success');
            }
        }

        // --- Lógica de Inicialización (Espera la respuesta del backend) ---
        window.onload = async function() {
            showMessage('Cargando estado de rutinas...', 'success');
            const dataLoaded = await fetchLastRoutineDates();
            
            // La función updateRoutineCards se ejecuta en cualquier caso.
            // Si la carga falla, usa el objeto 'lastRoutineDates' vacío, desbloqueando todo (excepto el día actual).
            updateRoutineCards(); 
            
            if (!dataLoaded && USER_ID !== "ID_DEL_USUARIO_ACTUAL") {
                 showMessage('Advertencia: No se pudo verificar el historial de rutinas. Se muestran todos los días desbloqueados.', 'error');
            }
        };
    </script>
</body>
</html>
