<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GYMENEZ</title>
    <link rel="icon" type="image/png" href="mini_logo.png">
    <link rel="shortcut icon" type="image/png" href="mini_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Tema de Fondo Minimalista: Base Oscura (DEFAULT/LOGIN) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a;
            /* Fondo Inicial (LOGIN) */
            background-image: url('FONDO.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #e5e7eb; 
            /* Transición para un cambio de fondo suave */
            transition: background-image 1s ease-in-out; 
            
            /* === APLICADO: Borde negro para todas las letras (Text Stroke Effect) === */
            text-shadow: 
                -0.5px -0.5px 0 #000,
                0.5px -0.5px 0 #000,
                -0.5px 0.5px 0 #000,
                0.5px 0.5px 0 #000;
        }

        /* Clase para el fondo del Dashboard */
        .dashboard-bg {
            background-image: url('FONDO_DASHBOARD.png');
        }

        /* Estilos específicos para la pantalla de carga (Splash) */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #0d0d1a;
            z-index: 1000;
            transition: opacity 0.5s ease-out;
            color: #9333ea; /* Color morado para el texto del splash */
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #9333ea; /* Color morado */
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilo para el contenedor principal de formularios */
        .form-container {
            max-width: 400px;
            padding: 2.5rem; /* p-10 */
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 10px 25px rgba(147, 51, 234, 0.3); /* Sombra morada */
            transition: all 0.3s ease-in-out;
        }

        /* Estilo para los botones principales (morado) */
        .btn-primary {
            background-color: #9333ea;
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-primary:hover {
            background-color: #7e22ce;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        /* Estilo para enlaces y texto secundario */
        .text-secondary {
            color: #d8b4fe; /* Morado claro */
        }

        /* Input styling */
        .input-field {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #4a044e;
            border-radius: 0.5rem;
            background-color: #1f1f2e;
            color: #e5e7eb;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-field:focus {
            border-color: #9333ea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.5);
        }

        /* Utility classes for screen management */
        .screen {
            display: none;
            min-height: 100vh;
        }

        .active-screen {
            display: flex;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Pantalla de Carga (Splash Screen) -->
    <div id="splash-screen" class="active-screen">
        <div class="text-center">
            <h1 class="text-5xl font-bold mb-4">GYMENEZ</h1>
            <div class="spinner mb-4"></div>
            <p class="text-lg">Cargando experiencia...</p>
        </div>
    </div>

    <!-- Pantalla de Inicio de Sesión (Login) -->
    <div id="login-screen" class="screen justify-center items-center p-4">
        <div class="form-container w-full">
            <h2 class="text-3xl font-bold text-center mb-6 text-secondary">Iniciar Sesión</h2>
            <form id="login-form">
                <input type="email" id="email" class="input-field" placeholder="Correo Electrónico" required>
                <input type="password" id="password" class="input-field" placeholder="Contraseña" required>
                <button type="submit" class="btn-primary w-full mt-2">Acceder</button>
            </form>
            <div id="login-message" class="text-center text-red-400 mt-4 h-6"></div>
            <div class="mt-6 text-center text-sm">
                <a href="#" id="forgot-password-link" class="text-secondary hover:underline mx-2">¿Olvidaste tu Contraseña?</a>
                <span class="text-gray-400">|</span>
                <a href="#" id="register-request-link" class="text-secondary hover:underline mx-2">Solicitar Registro</a>
            </div>
        </div>
    </div>

    <!-- Pantalla de Dashboard (Ruta Protegida) -->
    <div id="dashboard-screen" class="screen flex-col justify-start items-center p-4 pt-10">
        <div class="w-full max-w-4xl">
            <header class="flex justify-between items-center mb-10 pb-4 border-b border-purple-800">
                <h1 class="text-4xl font-extrabold text-secondary">GYMENEZ <span class="text-gray-400">Dashboard</span></h1>
                <button id="logout-button" class="btn-primary bg-red-600 hover:bg-red-700">Cerrar Sesión</button>
            </header>
            
            <div id="logout-message" class="text-center text-red-400 mb-4 h-6 font-semibold"></div>

            <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Tarjeta de Perfil -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-purple-700">
                    <h3 class="text-2xl font-semibold mb-3 text-secondary">Mi Perfil</h3>
                    <p class="text-gray-300">Aquí verás tu información personal, progreso y métricas de salud.</p>
                    <button class="mt-4 btn-primary bg-purple-600 hover:bg-purple-700 text-sm">Ver Detalles</button>
                </div>

                <!-- Tarjeta de Rutina del Día -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-purple-700">
                    <h3 class="text-2xl font-semibold mb-3 text-secondary">Rutina de Hoy</h3>
                    <p class="text-gray-300">Entrenamiento de fuerza y cardio. ¡Vamos a por ello!</p>
                    <button class="mt-4 btn-primary bg-purple-600 hover:bg-purple-700 text-sm">Iniciar Rutina</button>
                </div>

                <!-- Tarjeta de Historial -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-purple-700">
                    <h3 class="text-2xl font-semibold mb-3 text-secondary">Historial</h3>
                    <p class="text-gray-300">Revisa tus rutinas completadas y las encuestas de bienestar.</p>
                    <button class="mt-4 btn-primary bg-purple-600 hover:bg-purple-700 text-sm">Ver Historial</button>
                </div>

                <!-- Mensaje de Bienvenida -->
                <div class="md:col-span-2 lg:col-span-3 bg-gray-900 p-8 rounded-xl shadow-2xl border-4 border-purple-500 text-center">
                    <p class="text-xl font-light">¡Bienvenido de nuevo! Tu bienestar es nuestra prioridad.</p>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- CONSTANTES ---
        const SPLASH_DURATION_MS = 2500;
        const LOGIN_API_URL = 'https://gymenez-api.pythonanywhere.com/api/login';
        const WHATSAPP_NUMBER = '+584120000000'; // Número de WhatsApp de ejemplo
        const WHATSAPP_MESSAGE_REGISTER = "Hola, me gustaría solicitar el registro para la aplicación GYMENEZ. Mi correo es [TU CORREO AQUÍ].";
        const WHATSAPP_MESSAGE_RECOVERY = "Hola, necesito ayuda para recuperar mi contraseña de GYMENEZ. Mi correo es [TU CORREO AQUÍ].";

        // --- FUNCIONES DE NAVEGACIÓN Y UTILIDAD ---

        // Función para generar un ID único (UUID v4 simplificado)
        function generateSessionId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function navigateTo(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active-screen');
            });
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.add('active-screen');
                // Cambiar el fondo del cuerpo si vamos al dashboard
                if (screenId === 'dashboard-screen') {
                    document.body.classList.add('dashboard-bg');
                } else {
                    document.body.classList.remove('dashboard-bg');
                }
            }
        }

        function transitionToLogin() {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.style.display = 'none';
                navigateTo('login-screen');
            }, 500); // Esperar la transición de opacidad
        }

        // --- GESTIÓN DE SESIÓN ---

        /**
         * @description Maneja la lógica de inicio de sesión, incluyendo la obtención
         * de un token y un ID de sesión único para la gestión multi-dispositivo.
         * ESTA ES LA FUNCIÓN CLAVE DONDE SE CORRIGE EL MANEJO DEL LOCAL STORAGE.
         */
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const messageElement = document.getElementById('login-message');
            messageElement.textContent = 'Iniciando sesión...';

            try {
                // 1. Simulación de llamada API al Backend (TU BACKEND REAL DEBE ESTAR AQUÍ)
                const response = await fetch(LOGIN_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // IMPORTANTE: Enviamos el email y password, NO el sessionId
                    body: JSON.stringify({ email: email, password: password })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Generamos un ID de sesión *único para este dispositivo*
                    const newSessionId = generateSessionId();

                    // El backend debe haber devuelto un token y user data
                    const sessionData = {
                        token: data.token, // Token real del backend
                        userId: data.userId,
                        email: email,
                        // === CLAVE: Almacenamos el SessionId único del nuevo login ===
                        sessionId: newSessionId, 
                        loginTime: new Date().toISOString()
                    };

                    // 2. Guardar la nueva sesión ANTES de cualquier redirección/chequeo
                    localStorage.setItem('userSession', JSON.stringify(sessionData));
                    messageElement.textContent = '¡Inicio de sesión exitoso!';
                    
                    // 3. Informar al backend que este es el nuevo SessionId activo
                    // **********************************************************************************
                    // LÓGICA DE UNIDAD DE SESIÓN ÚNICA EN EL BACKEND:
                    // En este punto, DEBES llamar al backend (p.ej., una API /update-session-id)
                    // con el 'userId' y el 'newSessionId'.
                    // El backend debe guardar este 'newSessionId' en el perfil del usuario.
                    // Cualquier otro dispositivo que esté activo y esté P O L E A N D O
                    // o usando un W E B S O C K E T para chequear el ID de sesión activo,
                    // verá que su ID ya no coincide con el de la DB, y ejecutará handleLogout()
                    // **********************************************************************************
                    
                    // 4. Navegar al dashboard
                    setTimeout(() => {
                        messageElement.textContent = '';
                        navigateTo('dashboard-screen');
                    }, 500);

                } else {
                    messageElement.textContent = data.error || 'Credenciales incorrectas.';
                }

            } catch (error) {
                console.error('Error durante el inicio de sesión:', error);
                messageElement.textContent = 'Error de conexión. Inténtalo de nuevo.';
            }
        }

        function handleLogout() {
            // Eliminar la sesión localmente
            localStorage.removeItem('userSession');
            
            // Si el backend necesita saber que esta sesión se cerró para limpiar algo
            // (p.ej., si estabas usando un mecanismo de 'keep-alive'), DEBERÍAS
            // hacer una llamada a una API /logout aquí.
            
            // Limpiar todos los estados dependientes de la sesión si es necesario
            navigateTo('login-screen');
            // Actualizar el fondo al estado predeterminado
            document.body.classList.remove('dashboard-bg');
            document.getElementById('logout-message').textContent = 'Sesión cerrada exitosamente.';
            console.log('User logged out.');
            
            // Limpiar el mensaje después de un tiempo
            setTimeout(() => {
                 document.getElementById('logout-message').textContent = '';
            }, 5000);
        }

        // =========================================================================================
        //  FUNCIÓN DE CHEQUEO DE ESTADO DE SESIÓN (ESTO ES LO QUE ESTABA CAUSANDO TU PROBLEMA)
        // =========================================================================================
        // Esta función SIMULA el chequeo que tu app probablemente tiene para forzar la sesión única.
        // Si no tienes una función como esta, el problema está en tu `handleLogin` (ya corregido arriba).
        // Si tienes una función de chequeo, asegúrate de que se ejecute solo si `localStorage` tiene datos.
        function checkSessionStatus() {
            const storedSession = localStorage.getItem('userSession');
            if (!storedSession) {
                // No hay sesión, no hay nada que chequear.
                return;
            }

            const sessionData = JSON.parse(storedSession);
            const currentSessionId = sessionData.sessionId;

            // **********************************************************************************
            // AQUÍ DEBERÍA IR UNA LLAMADA PERIÓDICA (POLLING) O UN LISTENER DE WEBSOCKET
            // A TU BACKEND.
            // **********************************************************************************
            
            /* SIMULACIÓN DE POLLING AL BACKEND
            
            fetch('/api/get-active-session?userId=' + sessionData.userId)
                .then(res => res.json())
                .then(data => {
                    const activeSessionIdInDB = data.activeSessionId;

                    // Si el ID guardado en localStorage NO coincide con el activo en la DB,
                    // significa que otro dispositivo inició sesión y debe cerrar esta.
                    if (currentSessionId !== activeSessionIdInDB) {
                        document.getElementById('logout-message').textContent = 'Tu sesión ha sido cerrada porque se ha iniciado sesión en otro dispositivo.';
                        handleLogout(); // Cierra la sesión
                    }
                })
                .catch(e => {
                    console.warn("No se pudo chequear el estado de la sesión.", e);
                });
            */
        }
        
        // --- WHATSAPP UTILITIES ---
        function handleRegisterRequest(event) {
            event.preventDefault();
            const encodedMessage = encodeURIComponent(WHATSAPP_MESSAGE_REGISTER);
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER.replace(/[^\\d+]/g, '')}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        function handleForgotPassword(event) {
            event.preventDefault();
            const encodedMessage = encodeURIComponent(WHATSAPP_MESSAGE_RECOVERY);
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER.replace(/[^\\d+]/g, '')}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        // --- Lógica de Inicialización ---
        window.onload = function() {
            // Comprobar si hay una sesión guardada para evitar login
            const storedSession = localStorage.getItem('userSession');
            if (storedSession) {
                // Si hay sesión guardada, saltar el splash y navegar al dashboard
                setTimeout(() => {
                    document.getElementById('splash-screen').style.display = 'none';
                    navigateTo('dashboard-screen');
                    
                    // Iniciar el chequeo de sesión inmediatamente si hay una guardada.
                    // Idealmente, esto debería ser un temporizador de polling (p.ej., cada 30s)
                    // o un WebSocket. Por ahora, solo es una función definida.
                    // setInterval(checkSessionStatus, 30000); // 30 segundos
                }, 100); 
            } else {
                // Si no hay sesión, iniciar la transición normal
                setTimeout(transitionToLogin, SPLASH_DURATION_MS);
            }

            // --- LISTENERS DE FORMULARIO ---
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            
            // LISTENERS PARA LOS NUEVOS ENLACES
            document.getElementById('register-request-link').addEventListener('click', handleRegisterRequest); 
            document.getElementById('forgot-password-link').addEventListener('click', handleForgotPassword);
        };
    </script>
</body>
</html>
