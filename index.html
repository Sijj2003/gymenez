<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GYMENEZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Configuración del fondo para que cubra toda la página */
            background-color: #0d0d1a;
            /* Usamos un fondo que puede ser un placeholder o una imagen */
            background-image: url('https://placehold.co/1920x1080/0d0d1a/ffffff?text=GYMENEZ+Background');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Estilo específico para el efecto Glassmorphism en las tarjetas */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }
        /* Estilo para el contenedor principal de la aplicación */
        .app-container {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            margin: 1rem;
        }

        /* Ocultar pantallas */
        .screen { display: none; }
        .screen.active { display: block; }

        /* Animación de splash */
        #splash-screen {
            transition: opacity 0.5s ease-out;
        }

        /* Estilo del botón de logout para mejor visibilidad */
        #logout-button {
            transition: background-color 0.3s, transform 0.1s;
        }
        #logout-button:hover {
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="text-white">

    <!-- Mensaje de Notificación Global (No usamos alert()) -->
    <div id="message-container" class="fixed top-4 right-4 z-50">
        <!-- Los mensajes se inyectan aquí -->
    </div>

    <div class="app-container">
        <!-- 1. PANTALLA DE CARGA (SPLASH) -->
        <div id="splash-screen" class="screen active text-center">
            <h1 class="text-5xl font-extrabold text-indigo-400 animate-pulse">GYMENEZ</h1>
            <p class="mt-4 text-xl text-gray-300">Cargando experiencia...</p>
        </div>

        <!-- 2. PANTALLA DE LOGIN -->
        <div id="login-screen" class="screen">
            <div class="glass-card p-6 rounded-xl shadow-2xl">
                <h2 class="text-3xl font-bold text-center mb-6 text-indigo-300">Iniciar Sesión</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-2">Correo Electrónico</label>
                        <input type="email" id="email" name="email" required placeholder="ejemplo@gymenez.com"
                               class="w-full px-4 py-2 rounded-lg bg-gray-700/50 border border-gray-600 focus:border-indigo-400 focus:outline-none transition duration-150">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Contraseña</label>
                        <input type="password" id="password" name="password" required placeholder="••••••••"
                               class="w-full px-4 py-2 rounded-lg bg-gray-700/50 border border-gray-600 focus:border-indigo-400 focus:outline-none transition duration-150">
                    </div>
                    <button id="login-button" type="submit"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition duration-200 disabled:opacity-50">
                        INGRESAR
                    </button>
                </form>
            </div>
        </div>

        <!-- 3. PANTALLA DE DASHBOARD -->
        <div id="dashboard-screen" class="screen">
            <div class="glass-card p-6 rounded-xl shadow-2xl text-center">
                <h2 class="text-3xl font-bold mb-4 text-green-400">¡Bienvenido!</h2>
                <p class="text-lg mb-6">Estás en el Dashboard. Aquí va el contenido de tu aplicación.</p>
                <div class="mb-4 p-3 bg-gray-700/50 rounded-lg">
                    <p class="text-sm font-semibold text-gray-300">ID de Usuario (UID):</p>
                    <p id="user-id-display" class="text-sm break-all text-indigo-300">Cargando...</p>
                </div>
                <button id="logout-button"
                        class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-200">
                    CERRAR SESIÓN
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importaciones de Firebase (URLs CDN v11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, getDoc, doc, setDoc, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Activar logs de debug para Firestore
        setLogLevel('Debug');

        const SPLASH_DURATION_MS = 1500;
        let db, auth, userId = null;
        let isAuthReady = false;

        // --- FUNCIONES DE UTILIDAD ---

        /**
         * Muestra un mensaje temporal de notificación.
         * @param {string} message - El texto del mensaje.
         * @param {'success'|'error'|'info'} type - El tipo de mensaje.
         */
        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const colorMap = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const element = document.createElement('div');
            element.className = `${colorMap[type]} text-white p-3 rounded-lg shadow-xl mb-2 transition-opacity duration-300 opacity-0`;
            element.textContent = message;
            
            container.appendChild(element);

            // Iniciar fade in
            setTimeout(() => element.style.opacity = '1', 10); 

            // Iniciar fade out y remover
            setTimeout(() => {
                element.style.opacity = '0';
                setTimeout(() => element.remove(), 300);
            }, 5000);
        }

        /**
         * Navega a una pantalla específica.
         * @param {string} targetId - El ID de la pantalla a mostrar.
         */
        function navigateTo(targetId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(targetId).classList.add('active');
        }

        /**
         * Transiciona de la pantalla de splash al login.
         */
        function transitionToLogin() {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            setTimeout(() => {
                splash.classList.remove('active');
                // La navegación real será manejada por onAuthStateChanged
            }, 500); // 500ms para que termine la transición de opacidad
        }

        // --- INICIALIZACIÓN DE FIREBASE Y AUTENTICACIÓN ---

        async function initializeFirebaseAndAuth() {
            try {
                // 1. Configuración
                const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config) 
                    ? JSON.parse(__firebase_config) 
                    : {};

                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config no está disponible. Usando configuración vacía.");
                    isAuthReady = true;
                    return; 
                }

                // 2. Inicializar App
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 3. Listener de Estado de Autenticación
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        navigateTo('dashboard-screen');
                    } else {
                        userId = null;
                        document.getElementById('user-id-display').textContent = 'No autenticado';
                        navigateTo('login-screen');
                    }
                    isAuthReady = true;
                    console.log(`Estado de Auth cambiado. User ID: ${userId}`);
                });

                // 4. Autenticación Inicial (Token o Anónima)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Autenticación con token personalizado exitosa.");
                } else {
                    await signInAnonymously(auth);
                    console.warn("Autenticación anónima utilizada (No hay token personalizado).");
                }

            } catch (e) {
                console.error("Error grave durante la inicialización de Firebase:", e);
                showMessage('Fallo en la inicialización de Firebase. Revisa la consola.', 'error');
                isAuthReady = true;
            }
        }

        // --- LÓGICA DE NEGOCIO ---
        
        /**
         * Intenta iniciar sesión con email y contraseña.
         */
        async function apiLogin(email, password) {
            if (!auth) return { success: false, error: "Firebase no inicializado." };

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged maneja la navegación después de este éxito.
                return { success: true };

            } catch (error) {
                console.error("Error de login:", error.code, error.message);
                let errorMessage = "Credenciales incorrectas o error desconocido.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = "Email o contraseña incorrectos.";
                }
                return { success: false, error: errorMessage };
            }
        }

        /**
         * Cierra la sesión del usuario.
         */
        async function apiLogout() {
            if (!auth) return { success: false, error: "Firebase no inicializado." };
            try {
                await signOut(auth);
                // onAuthStateChanged maneja la navegación después de este éxito.
                return { success: true };
            } catch (error) {
                console.error("Error de logout:", error);
                return { success: false, error: "Error al cerrar sesión." };
            }
        }


        // --- MANEJADORES DE EVENTOS ---

        /**
         * Maneja el evento de envío del formulario de login.
         */
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('login-button');

            if (!isAuthReady) {
                showMessage('La autenticación aún no está lista. Inténtalo de nuevo.', 'info');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Ingresando...';

            const response = await apiLogin(email, password);
            
            if (response.success) {
                showMessage('¡Bienvenido!', 'success');
            } else {
                showMessage(response.error, 'error');
            }
            
            btn.disabled = false;
            btn.textContent = 'INGRESAR';
        }

        /**
         * Cierra la sesión del usuario.
         */
        async function handleLogout() {
            const btn = document.getElementById('logout-button');
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = 'Cerrando...';

            const response = await apiLogout();
            
            if (response.success) {
                showMessage('Sesión cerrada correctamente.', 'success');
            } else {
                showMessage('Error al cerrar sesión.', 'error');
            }

            btn.disabled = false;
            btn.textContent = originalText;
        }

        // --- Lógica de Inicialización ---
        window.onload = function() {
            // Inicializar Firebase y Autenticación
            initializeFirebaseAndAuth();

            // Iniciar la transición de la pantalla de carga al login/dashboard
            setTimeout(transitionToLogin, SPLASH_DURATION_MS);

            // --- LISTENERS DE FORMULARIO ---
            // Los listeners deben agregarse DESPUÉS de que se ha renderizado el HTML
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }
        };
    </script>
</body>
</html>
