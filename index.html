<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GYMENEZ</title>
    <link rel="icon" type="image/png" href="mini_logo.png">
    <link rel="shortcut icon" type="image/png" href="mini_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // ‚ö†Ô∏è INICIALIZACI√ìN DE FIREBASE:
        // Aseg√∫rate de reemplazar este placeholder con tu configuraci√≥n REAL de Firebase
        /* const firebaseConfig = {
             apiKey: "TU_API_KEY",
             authDomain: "TU_AUTH_DOMAIN",
             projectId: "TU_PROJECT_ID",
             // ... otros par√°metros
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        */

        // Placeholder para la inicializaci√≥n. **DEBES AGREGAR TU C√ìDIGO REAL AQU√ç**
        if (typeof firebase !== 'undefined') {
            // Inicializa tu App aqu√≠
        }
        
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Tema de Fondo Minimalista: Base Oscura (DEFAULT/LOGIN) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a;
            /* Fondo Inicial (LOGIN) */
            background-image: url('FONDO.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #e5e7eb; 
            /* Transici√≥n para un cambio de fondo suave */
            transition: background-image 1s ease-in-out; 
            
            /* === APLICADO: Borde negro para todas las letras (Text Stroke Effect) === */
            text-shadow: 
                -0.5px -0.5px 0 
                /* ... EL RESTO DE TUS ESTILOS ... */
        }
    </style>
</head>
<body>
    <script>
        // ... (Tus funciones existentes como formatDateInput, showForceLogoutMessage, handleForceLogout, etc., van aqu√≠) ...
        
        // ---------------------------------------------------------------------------------
        // üöÄ FUNCIONES CLAVE PARA EL CIERRE DE SESI√ìN INSTANT√ÅNEO (NUEVAS)
        // ---------------------------------------------------------------------------------

        /**
         * Funci√≥n que ejecuta el cierre de sesi√≥n local (limpieza de tokens y redirecci√≥n).
         */
        function performLocalLogout() {
            console.log("Cerrando sesi√≥n local instant√°neamente...");
            
            // 1. Limpiar tokens/cookies/localStorage
            localStorage.removeItem('userToken');
            localStorage.removeItem('currentUserId'); 
            
            // 2. Redirigir al usuario
            window.location.href = '/'; // Redirige a la p√°gina de inicio o login
        }


        /**
         * Configura un listener de Firestore para detectar el cierre de sesi√≥n forzado.
         * Se activa de forma INSTANT√ÅNEA cuando el servidor cambia 'session_status'.
         * @param {string} userId - El ID del usuario actual.
         */
        function setupSessionListener(userId) {
            if (!window.firebase || !window.firebase.firestore) {
                console.error("Firebase SDK o Firestore no est√° disponible.");
                return;
            }

            // Asume que la instancia 'db' de firestore est√° disponible o la inicializa
            const db = window.firebase.firestore(); 
            
            // Referencia al documento que el servidor est√° actualizando (Colecci√≥n 'users')
            const userDocRef = db.collection("users").doc(userId); 

            console.log(`Iniciando escucha de sesi√≥n para el usuario: ${userId}`);

            // El listener en tiempo real: onSnapshot
            const unsubscribe = userDocRef.onSnapshot(docSnapshot => {
                if (docSnapshot.exists) {
                    const data = docSnapshot.data();
                    
                    // üí° L√ìGICA CLAVE: Si el servidor establece 'logout_requested', cerramos sesi√≥n.
                    if (data.session_status === 'logout_requested') {
                        console.log("‚úÖ Solicitud de cierre de sesi√≥n forzado INSTANT√ÅNEA recibida.");
                        
                        // Detener el listener (para liberar recursos)
                        unsubscribe(); 
                        
                        // Ejecuta el cierre de sesi√≥n local
                        performLocalLogout(); 
                        
                        // Mostrar un mensaje (opcional)
                        alert("Tu sesi√≥n ha sido cerrada remotamente por seguridad.");
                    }
                }
            }, err => {
                console.error("Error al escuchar cambios en la sesi√≥n:", err);
            });

            return unsubscribe; 
        }
        
        // ---------------------------------------------------------------------------------
        // L√ìGICA EXISTENTE DEL DOCUMENTO (A√ëADE LA LLAMADA AQUI)
        // ---------------------------------------------------------------------------------
        
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('force-logout-modal');
            const options = document.getElementById('modal-options');
            const form = document.getElementById('force-logout-form');
            const loginEmailInput = document.getElementById('login-email'); 

            // ... (Tu c√≥digo existente para los listeners de los botones del modal) ...
            
            // Bot√≥n 'No, volver al login'
            document.getElementById('modal-cancel-btn').addEventListener('click', () => {
                modal.classList.add('hidden');
                options.classList.add('hidden');
                // Limpiar mensaje al cancelar
                /* ... showForceLogoutMessage(''); ... */
            });
            
            // Bot√≥n 'S√≠, Cerrar Sesi√≥n' (Muestra el formulario de verificaci√≥n)
            document.getElementById('modal-confirm-btn').addEventListener('click', () => {
                options.classList.add('hidden');
                form.classList.remove('hidden');
                
                // Precargar email (solo lectura) para conveniencia
                document.getElementById('force-email').value = loginEmailInput.value;
            });
            
            // Bot√≥n 'Cancelar' del formulario (Cierra la modal y devuelve al login)
            document.getElementById('force-logout-cancel').addEventListener('click', () => {
                modal.classList.add('hidden');
                /* ... showForceLogoutMessage(''); ... */
                
                // Limpieza interna 
                options.classList.remove('hidden');
                form.classList.add('hidden');
            });

            // Listener para el env√≠o del formulario de cierre forzado
            /* ... form.addEventListener('submit', handleForceLogout); ... */
            
            // LISTENER para el formato autom√°tico de la Fecha de Nacimiento
            /* ... document.getElementById('force-dob').addEventListener('input', (e) => formatDateInput(e.target)); ... */
            
            
            // ---------------------------------------------------------------------------------
            // üîë LLAMADA CLAVE PARA INICIAR LA ESCUCHA DE SESI√ìN
            // ---------------------------------------------------------------------------------
            
            // DEBES LLAMAR A ESTA FUNCI√ìN DESPU√âS DE UN LOGIN EXITOSO
            // O al cargar la p√°gina si el usuario ya est√° autenticado.
            
            const loggedInUserId = localStorage.getItem('currentUserId'); // Asumiendo que guardas el ID aqu√≠
            
            if (loggedInUserId) {
                 // **ESTA ES LA L√çNEA QUE REEMPLAZA TU ANTIGUA L√ìGICA DE POLLING DE 15 SEGUNDOS**
                 setupSessionListener(loggedInUserId);
                 console.log("Escucha de cierre forzado iniciada al cargar la app.");
            } else {
                 console.log("Usuario no logueado, no se inicia la escucha de sesi√≥n.");
            }
            
            /* // Tambi√©n debes agregar la llamada dentro de tu funci√≥n que maneja el inicio de sesi√≥n exitoso:
            // Ejemplo:
            // function handleSuccessfulLogin(userId) {
            //     localStorage.setItem('currentUserId', userId); 
            //     setupSessionListener(userId); 
            //     // ... navegaci√≥n a la app ...
            // }
            */
            
        });
        
        // ... (El resto de tus funciones) ...
    </script>
</body>
</html>
