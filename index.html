# ====================================================================
# ENDPOINT: CIERRE FORZADO DE SESIN (Final y Corregido)
# ====================================================================

@app.route('/api/force_logout', methods=['POST'])
def force_logout():
    """
    Ruta para cerrar sesi贸n activa forzadamente si los datos de verificaci贸n coinciden 
    con el perfil (profiles) del usuario, utilizando validaci贸n flexible.
    """

    if users_collection is None or profiles_collection is None:
         return jsonify({'success': False, 'error': 'El servidor no pudo inicializar la base de datos (503).'}), 503

    data = request.json
    email = data.get('email')
    password = data.get('password') # Contrase帽a del login
    device_id = data.get('deviceId') # DeviceId de la nueva sesi贸n
    name_input_raw = data.get('name', '') # Primer Nombre del formulario
    dob_input = data.get('dob', '') # dd/mm/yyyy del formulario
    phone_input_raw = data.get('phone', '') # Tel茅fono del formulario
    ci_input_raw = data.get('ci', '')       # C茅dula del formulario

    if not all([email, password, device_id, name_input_raw, dob_input, phone_input_raw, ci_input_raw]):
        return jsonify({'success': False, 'error': 'Faltan datos de verificaci贸n esenciales.'}), 400

    try:
        # 1. Buscar Usuario y Verificar Contrase帽a
        query = users_collection.where('email', '==', email).limit(1).get()
        if not query:
            return jsonify({'success': False, 'error': 'Credenciales o datos de verificaci贸n inv谩lidos.'}), 401
        
        user_doc = query[0]
        user_data = user_doc.to_dict()
        user_id_str = user_doc.id

        if not (user_data and user_data.get('password_hash') == password):
             return jsonify({'success': False, 'error': 'Contrase帽a incorrecta. Intente de nuevo.'}), 401

        # 2. Obtener Perfil (Profiles)
        profile_doc = profiles_collection.document(user_id_str).get()
        if not profile_doc.exists:
             return jsonify({'success': False, 'error': 'No se encontr贸 un perfil asociado. Contacte soporte.'}), 404

        profile_data = profile_doc.to_dict()

        # 3. Mapeo y Normalizaci贸n de Datos para la Coincidencia

        # 3a. NOMBRE (Flexible: Case/Accent Insensitive y solo Primer Nombre)
        # El campo en DB es 'name', ej: 'SEBASTIAN ISAAC'
        name_db_full = profile_data.get('name', '') 
        
        # Normalizar y tomar solo la primera palabra de la DB
        name_db_normalized_parts = normalize_string(name_db_full).split(' ')
        name_db_normalized = name_db_normalized_parts[0] if name_db_normalized_parts else ''
        
        # Normalizar el input del usuario
        name_input_normalized = normalize_string(name_input_raw)

        name_match = (name_input_normalized == name_db_normalized)
        
        # 3b. TELFONO y CDULA (Solo d铆gitos para comparaci贸n)
        # Los campos correctos en DB son: 'phone_number' y 'id_number'
        phone_db_raw = profile_data.get('phone_number', '') 
        ci_db_raw = profile_data.get('id_number', '')      

        # Eliminamos cualquier no-d铆gito para una comparaci贸n segura
        phone_db_digits = "".join(filter(str.isdigit, phone_db_raw))
        phone_input_digits = "".join(filter(str.isdigit, phone_input_raw))
        
        ci_db_digits = "".join(filter(str.isdigit, ci_db_raw))
        ci_input_digits = "".join(filter(str.isdigit, ci_input_raw))
        
        # 3c. FECHA DE NACIMIENTO (Comparaci贸n exacta, ya que el frontend la formatea)
        dob_db = profile_data.get('dob', '') # Ej: '28/04/2003'
        dob_match = (dob_db == dob_input)

        # 4. Evaluaci贸n Final de Coincidencia
        if (not name_match or 
            not dob_match or 
            phone_db_digits != phone_input_digits or 
            ci_db_digits != ci_input_digits):
            
            #  Este error 403 es el que se enviar谩 al frontend si no coinciden los datos
            return jsonify({
                'success': False, 
                'error': 'Error de Verificaci贸n: Los datos personales (Nombre, Fecha de Nacimiento, Tel茅fono o C茅dula) no coinciden.'
            }), 403 

        # 5. Forzar Cierre de Sesi贸n y Abrir la Nueva
        users_collection.document(user_id_str).update({
            'activeSessionId': device_id
        })

        # 6. Preparar Respuesta
        user_response = {
            'id': user_id_str,
            '_id': user_id_str,
            'email': user_data['email'],
            'name': user_data.get('name', email.split('@')[0])
        }

        return jsonify({'success': True, 'user': user_response})

    except Exception as e:
        import sys
        print(f"Error en force_logout: {e}", file=sys.stderr)
        return jsonify({'success': False, 'error': 'Error interno al intentar forzar el cierre de sesi贸n.'}), 500
