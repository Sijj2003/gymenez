<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GYMENEZ</title>
    <link rel="icon" type="image/png" href="mini_logo.png">
    <link rel="shortcut icon" type="image/png" href="mini_logo.png">
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Tema de Fondo Minimalista: Base Oscura (DEFAULT/LOGIN) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a;
            /* Fondo Inicial (LOGIN) */
            background-image: url('FONDO.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #e5e7eb; 
            /* Transición para un cambio de fondo suave */
            transition: background-image 1s ease-in-out; 
        }
        
        /* Estilo específico para el efecto Glassmorphism en las tarjetas */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.5);
        }

        /* Estilo para mensajes (Toast/Alerta) */
        #message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(-50px);
        }

        #message-box.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Estilo para el botón de login */
        #login-button {
            transition: all 0.3s ease;
        }

        /* Colores para estados del mensaje */
        .msg-success { background-color: #10b981; } /* Emerald-500 */
        .msg-error { background-color: #ef4444; } /* Red-500 */
    </style>
</head>
<body class="selection:bg-purple-600 selection:text-white">

    <!-- Mensaje de Alerta/Toast -->
    <div id="message-box" class="p-4 rounded-lg text-white font-semibold shadow-2xl"></div>

    <!-- PANTALLA DE SPLASH -->
    <div id="splash-screen" class="flex flex-col items-center justify-center min-h-screen transition-opacity duration-1000 bg-[#0d0d1a]">
        <img id="splash-logo" src="LOADING.png" alt="Loading" class="w-24 h-24 object-contain animate-pulse">
        <p class="text-xl mt-4 text-gray-400">Cargando GYMENEZ...</p>
    </div>

    <!-- PANTALLA DE LOGIN -->
    <div id="login-screen" class="hidden flex items-center justify-center min-h-screen">
        <div class="glass-card p-8 w-full max-w-md mx-auto rounded-3xl text-center">
            <img src="logo gymenez sin fondo.png" alt="GYMENEZ Logo" class="w-48 mx-auto mb-6">
            <h1 class="text-3xl font-bold mb-6 text-purple-400">BIENVENIDO</h1>
            
            <form id="login-form" class="space-y-6">
                <!-- Campo ID de Usuario -->
                <div>
                    <input type="text" id="user-id" placeholder="ID de Usuario" required
                           class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-10 border border-gray-700 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 text-white placeholder-gray-400 outline-none transition duration-200"
                           value="12345">
                </div>
                
                <!-- Campo Contraseña -->
                <div>
                    <input type="password" id="password" placeholder="Contraseña" required
                           class="w-full px-4 py-3 rounded-xl bg-white bg-opacity-10 border border-gray-700 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 text-white placeholder-gray-400 outline-none transition duration-200"
                           value="password">
                </div>
                
                <!-- Botón de Ingreso -->
                <button type="submit" id="login-button"
                        class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-extrabold rounded-xl shadow-lg hover:shadow-purple-500/50 transform hover:scale-[1.02] transition duration-300 ease-in-out">
                    INGRESAR
                </button>
            </form>

            <p class="mt-6 text-sm text-gray-400">
                ¿Problemas para acceder? Contacte a soporte.
            </p>
        </div>
    </div>

    <!-- PANTALLA DE DASHBOARD (Añadido: Estructura para Perfil y Rutinas) -->
    <div id="dashboard-screen" class="hidden min-h-screen p-4 sm:p-8">
        <!-- Header/Nav -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 space-y-4 sm:space-y-0">
            <div class="flex items-center space-x-4">
                <img src="logo gymenez sin fondo.png" alt="GYMENEZ Logo" class="h-8">
                <h1 class="text-3xl font-extrabold text-purple-400">Dashboard de Usuario</h1>
            </div>
            <button id="logout-button" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition duration-200 shadow-xl w-full sm:w-auto">
                CERRAR SESIÓN
            </button>
        </header>

        <!-- Main Content Area (Utilizando Glassmorphism para consistencia) -->
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Tarjeta de Perfil de Usuario (Sidebar en Desktop) -->
            <div class="glass-card p-6 w-full lg:w-1/3 rounded-xl min-h-[300px] border-l-4 border-purple-500">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2 text-purple-300">Mi Perfil</h2>
                <div id="profile-details" class="space-y-3">
                    <p><strong class="text-gray-400">Nombre:</strong> <span id="profile-name" class="block text-xl font-semibold">Cargando...</span></p>
                    <p><strong class="text-gray-400">Nivel Actual:</strong> <span id="profile-level" class="block text-xl font-semibold text-yellow-400">Cargando...</span></p>
                    <!-- Campos adicionales (e.g., Edad, etc.) se cargarán aquí -->
                </div>
            </div>

            <!-- Área de Rutinas/Dashboard Principal -->
            <div class="w-full lg:w-2/3">
                <div class="glass-card p-6 rounded-xl min-h-[300px] border-t-4 border-purple-500">
                    <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2 text-purple-300">Mis Rutinas Disponibles</h2>
                    <div id="routines-list" class="space-y-4">
                        <p class="text-gray-500">Cargando rutinas...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURACIÓN Y UTILIDADES ---
        const SPLASH_DURATION_MS = 1500;
        const BASE_API_URL = 'http://127.0.0.1:5000/api'; // URL del servidor Flask

        /**
         * Muestra un mensaje temporal (toast) al usuario.
         * @param {string} message - El contenido del mensaje.
         * @param {('success'|'error')} type - El tipo de mensaje (para el color).
         */
        function showMessage(message, type) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = `p-4 rounded-lg text-white font-semibold shadow-2xl ${type === 'success' ? 'msg-success' : 'msg-error'}`;
            msgBox.classList.add('show');

            setTimeout(() => {
                msgBox.classList.remove('show');
            }, 4000);
        }

        /**
         * Navega a una pantalla específica, ocultando las demás.
         * @param {string} screenId - El ID de la pantalla a mostrar (e.g., 'login-screen').
         */
        function navigateTo(screenId) {
            ['splash-screen', 'login-screen', 'dashboard-screen'].forEach(id => {
                const screen = document.getElementById(id);
                if (screen) {
                    screen.style.display = (id === screenId) ? 'flex' : 'none';
                }
            });
        }

        /**
         * Transición de Splash a Login.
         */
        function transitionToLogin() {
            navigateTo('login-screen');
            // Opcional: Cambiar el fondo si el dashboard tiene uno diferente.
            document.body.style.backgroundImage = "url('FONDO.png')"; 
        }

        // --- FUNCIONES DE API ---

        /**
         * Realiza la llamada a la API para login.
         * @param {string} userId - ID del usuario.
         * @param {string} password - Contraseña.
         * @returns {Promise<Object>} - Resultado de la API.
         */
        async function apiLogin(userId, password) {
            try {
                const response = await fetch(`${BASE_API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password })
                });

                if (!response.ok) {
                    // Si el estado HTTP no es 200, lanzar un error
                    const errorData = await response.json();
                    return { success: false, error: errorData.error || `Error HTTP: ${response.status}` };
                }

                const data = await response.json();
                return data;

            } catch (error) {
                console.error('Error en la llamada a apiLogin:', error);
                return { success: false, error: 'Error de conexión con el servidor.' };
            }
        }

        /**
         * Realiza la llamada a la API para cerrar sesión.
         */
        async function apiLogout() {
            try {
                // Obtener el ID de usuario de la sesión guardada
                const session = JSON.parse(localStorage.getItem('userSession'));
                const userId = session ? session.user_id : null;

                if (!userId) {
                    localStorage.removeItem('userSession');
                    return { success: true }; // Simular éxito si no hay sesión
                }

                const response = await fetch(`${BASE_API_URL}/logout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Enviar solo el ID de usuario para cerrar sesión en el backend si es necesario
                    body: JSON.stringify({ user_id: userId }) 
                });

                // Aunque la respuesta no sea 'ok', limpiamos la sesión localmente
                localStorage.removeItem('userSession');
                
                if (response.ok) {
                    return { success: true };
                } else {
                     console.warn(`Logout remoto falló con status ${response.status}, pero sesión local cerrada.`);
                     return { success: true }; // Considerar un logout local como exitoso
                }

            } catch (error) {
                console.error('Error en la llamada a apiLogout:', error);
                localStorage.removeItem('userSession');
                return { success: true }; // Considerar un logout local como exitoso
            }
        }
        
        /**
         * Realiza la llamada a la API para obtener el perfil y las rutinas.
         * @param {string} userId - ID del usuario.
         * @returns {Promise<Object>} - Resultado de la API.
         */
        async function apiGetData(userId) {
            try {
                const response = await fetch(`${BASE_API_URL}/data/${userId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    return { success: false, error: errorData.error || `Error HTTP: ${response.status}` };
                }

                const data = await response.json();
                return data;

            } catch (error) {
                console.error('Error en la llamada a apiGetData:', error);
                return { success: false, error: 'Error al obtener datos del servidor.' };
            }
        }

        // --- LÓGICA DEL DASHBOARD ---

        /**
         * Actualiza el HTML del dashboard con los datos del usuario.
         * @param {Object} data - Objeto que contiene 'profile' y 'routines'.
         */
        function updateDashboard(data) {
            const profile = data.profile || {};
            const routines = data.routines || [];
            
            // 1. Actualizar Detalles del Perfil
            document.getElementById('profile-name').textContent = profile.name || 'Sin nombre';
            document.getElementById('profile-level').textContent = profile.level || 'Básico';

            const profileDetails = document.getElementById('profile-details');
            
            // Limpiar los detalles existentes (solo mantiene los campos base)
            profileDetails.innerHTML = `
                <p><strong class="text-gray-400">Nombre:</strong> <span id="profile-name" class="block text-xl font-semibold">${profile.name || 'Sin nombre'}</span></p>
                <p><strong class="text-gray-400">Nivel Actual:</strong> <span id="profile-level" class="block text-xl font-semibold text-yellow-400">${profile.level || 'Básico'}</span></p>
            `;
            
            // Agregar otros campos del perfil si existen (ej. edad, activo desde)
            if (profile.age) {
                 profileDetails.innerHTML += `<p><strong class="text-gray-400">Edad:</strong> <span class="block text-xl font-semibold">${profile.age} años</span></p>`;
            }
            if (profile.activo_desde) {
                 profileDetails.innerHTML += `<p><strong class="text-gray-400">Activo Desde:</strong> <span class="block text-xl font-semibold">${profile.activo_desde}</span></p>`;
            }


            // 2. Actualizar Lista de Rutinas
            const routinesList = document.getElementById('routines-list');
            routinesList.innerHTML = ''; // Limpiar lista

            if (routines.length > 0) {
                routines.forEach(routine => {
                    const routineItem = document.createElement('div');
                    // Usamos el estilo glass-card sutilmente para cada rutina
                    routineItem.className = 'p-4 glass-card rounded-lg border-l-4 border-purple-400 hover:bg-opacity-10 transition duration-200 cursor-pointer'; 
                    routineItem.innerHTML = `
                        <h4 class="text-xl font-bold text-purple-300">${routine.name}</h4>
                        <p class="text-gray-400 text-sm">Nivel: ${routine.level} | Duración: ${routine.duration}</p>
                        <p class="mt-1 text-sm text-gray-300">${routine.description.substring(0, 100)}...</p>
                    `;
                    // Añadir un listener simple para un futuro detalle
                    routineItem.addEventListener('click', () => {
                         showMessage(`Seleccionaste la rutina: ${routine.name}`, 'success');
                         console.log('Detalle de la rutina:', routine);
                    });
                    routinesList.appendChild(routineItem);
                });
            } else {
                routinesList.innerHTML = '<p class="text-gray-500 italic">No hay rutinas asignadas en este momento.</p>';
            }
        }

        // --- LÓGICA DE MANEJO DE EVENTOS ---

        /**
         * Maneja el envío del formulario de login.
         * @param {Event} e - Evento de formulario.
         */
        async function handleLogin(e) {
            e.preventDefault();
            
            const userId = document.getElementById('user-id').value.trim();
            const password = document.getElementById('password').value.trim();
            const btn = document.getElementById('login-button');
            
            if (!userId || !password) {
                showMessage('Por favor, ingresa tu ID y contraseña.', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Verificando...';

            const loginResponse = await apiLogin(userId, password);

            if (loginResponse.success) {
                // 1. Guardar la sesión y el token
                localStorage.setItem('userSession', JSON.stringify({
                    user_id: userId,
                    token: loginResponse.token // Asumiendo que el token viene en la respuesta
                }));
                
                // 2. Obtener datos (perfil y rutinas)
                const dataResponse = await apiGetData(userId);

                if (dataResponse.success) {
                    updateDashboard(dataResponse);
                    showMessage(`¡Bienvenido, ${dataResponse.profile.name || userId}!`, 'success');
                } else {
                    // Si falla la obtención de datos, aún se inicia sesión pero con alerta
                    showMessage(`Sesión iniciada, pero error al cargar datos: ${dataResponse.error}`, 'error');
                    updateDashboard({}); // Cargar dashboard vacío o con info por defecto
                }
                
                // 3. Navegar al dashboard
                navigateTo('dashboard-screen');

            } else {
                showMessage(loginResponse.error || 'Error de inicio de sesión.', 'error');
            }
            
            btn.disabled = false;
            btn.textContent = 'INGRESAR';
        }

        /**
         * Cierra la sesión del usuario.
         */
        async function handleLogout() {
            const btn = document.getElementById('logout-button');
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = 'Cerrando...';

            await apiLogout(); // La función apiLogout maneja la limpieza local y remota
            
            showMessage('Sesión cerrada correctamente.', 'success');
            navigateTo('login-screen');

            btn.disabled = false;
            btn.textContent = originalText;
        }

        // --- Lógica de Inicialización ---
        window.onload = function() {
            // --- LISTENERS DE FORMULARIO ---
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Usamos un querySelectorAll porque el botón de logout existe en ambas pantallas
            document.querySelectorAll('#logout-button').forEach(btn => {
                 btn.addEventListener('click', handleLogout);
            });

            // Comprobar si hay una sesión guardada para evitar login
            const storedSession = localStorage.getItem('userSession');
            if (storedSession) {
                const session = JSON.parse(storedSession);
                
                // Si hay sesión guardada, intentar cargar el dashboard
                setTimeout(async () => {
                    document.getElementById('splash-screen').style.display = 'none';
                    const dataResponse = await apiGetData(session.user_id);
                    
                    if (dataResponse.success) {
                        updateDashboard(dataResponse);
                        navigateTo('dashboard-screen');
                        showMessage('Sesión reanudada.', 'success');
                    } else {
                        // Si falla al cargar los datos, forzar el re-login
                        localStorage.removeItem('userSession');
                        transitionToLogin();
                        showMessage('Error al reanudar sesión. Por favor, inicia sesión de nuevo.', 'error');
                    }
                }, 100); 
            } else {
                // Si no hay sesión, iniciar la transición normal
                setTimeout(transitionToLogin, SPLASH_DURATION_MS);
            }
        };
    </script>
</body>
</html>
