<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario - GYMENEZ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Tema de Fondo Minimalista: Base Oscura */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a;
            /* Fondo de perfil (usando el mismo que el dashboard) */
            background-image: url('PROFILE_FONDO.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #e5e7eb; 
            
            /* === NUEVO: Borde negro para todas las letras (Text Stroke Effect) === */
            text-shadow: 
                -0.5px -0.5px 0 #000,  
                 0.5px -0.5px 0 #000,
                -0.5px  0.5px 0 #000,
                 0.5px  0.5px 0 #000;
        }
        
        /* Estilo espec√≠fico para el efecto Glassmorphism en las tarjetas */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.5);
        }

        /* === ESTILO: T√≠tulo Amarillo con Borde Negro (Alto Contraste) === */
        .title-amber-stroke {
            color: #fcd34d; /* Amarillo Amber-400 */
            text-shadow:
                -1px -1px 0 #000,  
                 1px -1px 0 #000,
                -1px  1px 0 #000,
                 1px  1px 0 #000,
                 0 0 5px #fcd34d; 
        }

        /* Estilo para las tablas de informaci√≥n */
        .profile-table {
            width: 100%;
            border-collapse: collapse;
        }
        .profile-table th, .profile-table td {
            padding: 0.75rem 0;
            text-align: left;
        }
        .profile-table th {
            color: #d1d5db; /* Gris m√°s claro para mayor contraste (antes #9ca3af) */
            font-weight: 500;
            width: 50%;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .profile-table td {
            color: #ffffff;
            font-weight: 600;
            text-align: right;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        /* Color de valor para Mediciones */
        .measurement-value {
            color: #fcd34d; /* Amarillo/√Åmbar */
            font-weight: 700;
        }

        /* === ESTILO: Sombra/Borde para el texto del Header (Gris) === */
        .text-border-gray {
            text-shadow: 0 0 3px #4b5563; 
        }

        /* Estilos para el mensaje de estado */
        #message-box {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            pointer-events: none;
        }
        .message-success { background-color: #10b981; color: white; } 
        .message-error { background-color: #ef4444; color: white; } 

    </style>
    </head>
<body class="min-h-screen p-4 md:p-8">

    <div id="message-box"></div>

    <div id="profile-screen" class="min-h-screen w-full">
        <header class="flex justify-between items-center py-4 px-2 mb-8">
            <h1 class="text-3xl font-extrabold uppercase tracking-wider text-border-gray">
                <span class="text-amber-400">GYM</span><span class="text-white">ENEZ</span>
            </h1>
            
            <a href="index.html" 
               class="px-4 py-2 text-sm font-semibold rounded-full bg-sky-600 text-white hover:bg-sky-500 transition duration-300">
                &larr; Dashboard
            </a>
        </header>

        <h2 class="text-3xl font-extrabold text-white mb-6">Mi Perfil</h2>

        <div id="loading-spinner" class="text-center py-12 text-lg text-gray-300">
            Cargando datos de perfil...
        </div>

        <div id="profile-content" class="grid grid-cols-1 gap-6 lg:grid-cols-3 hidden">
            
            <div class="glass-card p-6 rounded-2xl lg:col-span-1">
                <h3 class="text-xl font-bold mb-4 title-amber-stroke flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    PERFIL
                </h3>
                <table id="profile-table" class="profile-table">
                    </table>
            </div>

            <div class="glass-card p-6 rounded-2xl lg:col-span-1">
                <h3 class="text-xl font-bold mb-4 title-amber-stroke flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    MEDICIONES GENERALES
                </h3>
                <table id="general-measurements-table" class="profile-table">
                    </table>
            </div>

            <div class="glass-card p-6 rounded-2xl lg:col-span-3">
                <h3 class="text-xl font-bold mb-4 title-amber-stroke flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    MEDICIONES CORPORALES (cm)
                </h3>
                <table id="body-measurements-table" class="profile-table">
                    </table>
            </div>
            
        </div>
    </div>


    <script>
        // üöÄ URL BASE DE TU API. SIN LA BARRA FINAL (/)
        const API_BASE_URL = 'https://sijj2003.pythonanywhere.com'; 
        const messagebox = document.getElementById('message-box');
        
        const loadingSpinner = document.getElementById('loading-spinner');
        const profileContent = document.getElementById('profile-content');


        // Funci√≥n para mostrar mensajes de estado
        function showMessage(message, type = 'success') {
            messagebox.textContent = message;
            messagebox.className = ''; 
            messagebox.classList.add('transition-none');
            messagebox.classList.add('message-' + type);
            messagebox.style.opacity = '1';
            messagebox.style.transform = 'translateX(-50%) translateY(0)';
            
            setTimeout(() => {
                messagebox.style.style = '';
                messagebox.style.opacity = '0';
                messagebox.style.transform = 'translateX(-50%) translateY(-20px)';
            }, 3000);
        }
        
        /**
         * Llama a la API para obtener el perfil y las mediciones del usuario.
         */
        async function apiFetchProfileData(userId) {
            console.log(`API: Intentando conectar a: ${API_BASE_URL}/api/profile/${userId}`);
            
            try {
                // 1. Intentar la conexi√≥n
                const response = await fetch(`${API_BASE_URL}/api/profile/${userId}`); 
                
                // 2. Verificar el estado HTTP
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'No hay cuerpo de respuesta');
                    console.error(`Error HTTP: ${response.status} - ${response.statusText}`, errorText);
                    
                    // Error espec√≠fico para el usuario
                    return { 
                        success: false, 
                        error: `Error del servidor (HTTP ${response.status} - ${response.statusText}). Revisa tu backend.`,
                        isServerError: true
                    };
                }

                // 3. Procesar la respuesta JSON
                const data = await response.json();
                
                if (!data.success) {
                    return { success: false, error: data.error || 'Error al obtener datos del perfil (API).' };
                }
                
                return { success: true, profile: data.profile };

            } catch (e) {
                // 4. Capturar errores de red (CORS, servidor inactivo, URL incorrecta)
                console.error("Error en la conexi√≥n fetch (Network/CORS):", e);
                return { 
                    success: false, 
                    error: `‚ùå Error de Conexi√≥n: ${e.message}. Revisa la URL, el estado del servidor y la configuraci√≥n CORS.`,
                    isNetworkError: true
                };
            }
        }


        /**
         * Renderiza la informaci√≥n del perfil en las tablas usando la data de la DB.
         */
        function renderProfile(data) {
            // --- 1. TABLA PERFIL ---
            const profileTable = document.getElementById('profile-table');
            profileTable.innerHTML = `
                <tr><th>Email</th><td>${data.email || 'N/A'}</td></tr>
                <tr><th>Nombre</th><td>${data.name || 'N/A'}</td></tr>
                <tr><th>Apellido</th><td>${data.last_name || 'N/A'}</td></tr>
                <tr><th>Fecha de Nacimiento</th><td>${data.dob || 'N/A'}</td></tr>
                <tr><th>Activo Desde</th><td>${data.activo_desde || 'N/A'}</td></tr>
                <tr><th>Sexo</th><td>${data.sex || 'N/A'}</td></tr>
            `;

            // --- 2. TABLA MEDICIONES GENERALES ---
            const generalTable = document.getElementById('general-measurements-table');
            generalTable.innerHTML = `
                <tr><th>Estatura</th><td><span class="measurement-value">${data.estatura ? data.estatura.toFixed(2) : 'N/A'}</span> m</td></tr>
                <tr><th>Peso</th><td><span class="measurement-value">${data.peso ? data.peso.toFixed(1) : 'N/A'}</span> kg</td></tr>
                <tr><th>√çndice de Grasa</th><td><span class="measurement-value">${data.indice_grasa ? data.indice_grasa.toFixed(1) : 'N/A'}</span> %</td></tr>
            `;
            
            // --- 3. TABLA MEDICIONES CORPORALES ---
            const bodyTable = document.getElementById('body-measurements-table');
            
            // Mapeo de claves de la DB (se asume snake_case) a etiquetas amigables
            const labels = {
                brazo_izquierdo: "Brazo Izquierdo",
                brazo_derecho: "Brazo Derecho",
                antebrazo_izquierdo: "Antebrazo Izquierdo",
                antebrazo_derecho: "Antebrazo Derecho",
                torax: "T√≥rax",
                cintura: "Cintura",
                cuadriceps_izquierdo: "Cu√°driceps Izquierdo",
                cuadriceps_derecho: "Cu√°driceps Derecho",
                gemelo_izquierdo: "Gemelo Izquierdo",
                gemelo_derecho: "Gemelo Derecho",
            };

            let bodyHtml = '';
            for (const key in labels) {
                 // Aseguramos que el valor sea un n√∫mero y lo formateamos a 1 decimal, si no, 'N/A'
                const value = data[key] !== undefined && data[key] !== null ? parseFloat(data[key]).toFixed(1) : 'N/A';
                
                bodyHtml += `
                    <tr>
                        <th>${labels[key]}</th>
                        <td><span class="measurement-value">${value}</span> cm</td>
                    </tr>
                `;
            }
            bodyTable.innerHTML = bodyHtml;
        }

        /**
         * Funci√≥n principal para cargar y mostrar los datos del perfil.
         */
        async function loadProfileData() {
            // 1. Obtener el ID de usuario de localStorage
            const storedSession = localStorage.getItem('userSession');
            
            if (!storedSession) {
                loadingSpinner.textContent = '‚ùå Error: No hay sesi√≥n activa. Redirigiendo a Login...';
                showMessage('No hay sesi√≥n activa.', 'error');
                // Redirigir al index si no hay sesi√≥n (CORRECCI√ìN HECHA AQU√ç)
                setTimeout(() => window.location.href = 'index.html', 3000); 
                return;
            }
            
            try {
                const userSession = JSON.parse(storedSession);
                const userId = userSession._id || userSession.id; 
                
                if (!userId) {
                    throw new Error("ID de usuario no encontrado en la sesi√≥n.");
                }

                // 2. Llamar a la API
                const response = await apiFetchProfileData(userId);

                // 3. Procesar respuesta
                if (response.success && response.profile) {
                    renderProfile(response.profile);
                    profileContent.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    showMessage('Datos de perfil cargados con √©xito.', 'success');
                } else {
                    // Muestra el error m√°s espec√≠fico devuelto por apiFetchProfileData
                    loadingSpinner.textContent = '‚ùå ' + (response.error || 'Error al cargar datos.');
                    showMessage('Error al cargar datos del perfil.', 'error');
                }

            } catch (error) {
                loadingSpinner.textContent = '‚ùå Error fatal: ' + error.message;
                showMessage('Error al procesar la sesi√≥n o la data.', 'error');
                console.error("Error en loadProfileData:", error);
            }
        }


        // --- L√≥gica de Inicializaci√≥n ---
        window.onload = function() {
            loadProfileData();
        };
    </script>
</body>
</html>
