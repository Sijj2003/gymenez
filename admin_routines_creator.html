<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GYMENEZ - Gesti√≥n de Rutinas</title>
    <link rel="icon" type="image/png" href="mini_logo.png">
    <link rel="shortcut icon" type="image/png" href="mini_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /*
         * ESTILOS BASE COPIADOS DE admin_users.html
         */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .GYM-YELLOW { color: #FFC300; }
        .bg-GYM-YELLOW { background-color: #FFC300; }
        .hover\:bg-GYM-YELLOW-dark:hover { background-color: #FFB300; }
        .border-GYM-YELLOW { border-color: #FFC300; }
        .focus\:ring-GYM-YELLOW:focus { --tw-ring-color: #FFC300; }
        .focus\:border-GYM-YELLOW:focus { border-color: #FFC300; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a;
            background-image: url('FONDO.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #e5e7eb;
            min-height: 100vh;
        }

        .dashboard-header {
            background-color: rgba(13, 13, 26, 0.9);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .content-container {
            background-color: rgba(18, 18, 30, 0.95);
            backdrop-filter: blur(3px);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            padding: 24px;
            margin-top: 24px;
        }

        .admin-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .admin-table th, .admin-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-table th {
            background-color: #1a1a2e;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.85); }
        .modal-content {
            background-color: #1a1a2e;
            border: 1px solid #334155;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        .modal-content input[type="text"], .modal-content textarea {
             background-color: #1a1a2e;
             border: 1px solid #334155;
             color: #e5e7eb;
        }
        /* Estilo para las casillas de verificaci√≥n */
        .day-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #334155;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s ease;
            vertical-align: middle;
        }
        .day-checkbox:checked {
            background-color: #FFC300;
            border-color: #FFC300;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='black' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }

    </style>
</head>
<body>
    
    <header class="dashboard-header">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">
                <span class="GYM-YELLOW">GYM</span>ENEZ - Gesti√≥n de Rutinas
            </h1>
            <nav class="space-x-4">
                <button id="back-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                    ‚Üê Regresar
                </button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        <div class="content-container mt-8">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3">
                <h2 class="text-xl font-semibold text-white">Lista de Rutinas Base</h2>
                <button id="add-routine-btn" class="bg-GYM-YELLOW hover:bg-GYM-YELLOW-dark text-black font-semibold py-2 px-4 rounded-lg text-sm transition duration-150 ease-in-out">
                    + A√±adir Rutina Base
                </button>
            </div>
            
            <div class="mb-6">
                <input type="text" id="routine-search-input" placeholder="Buscar por Nombre o Descripci√≥n..." 
                       class="w-full p-3 rounded-lg bg-[#1a1a2e] border border-gray-700 text-gray-300 placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-GYM-YELLOW focus:border-GYM-YELLOW transition duration-150">
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-700">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Nombre de la Rutina</th>
                            <th>D√≠as Asignados</th>
                            <th>Descripci√≥n</th>
                            <th class="rounded-tr-lg">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="routines-table-body" class="text-sm text-gray-300 divide-y divide-gray-800">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="routine-modal" class="fixed inset-0 bg-black bg-opacity-80 modal-backdrop hidden z-[1010] flex justify-center p-4 overflow-y-auto">
        
        <div class="modal-content w-full max-w-xl p-6 rounded-xl transform transition-all duration-300 scale-100">
            
            <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-6">
                <h3 id="modal-title" class="text-2xl font-semibold text-white">A√±adir Nueva Rutina Base</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-GYM-YELLOW text-3xl leading-none transition-colors duration-200">&times;</button>
            </div>

            <form id="routine-form" class="space-y-6">
                <input type="hidden" id="routine-id-field" name="id">
                <input type="hidden" id="is-edit-mode" value="false">
                <input type="hidden" id="exercises-field" name="exercises" value="[]"> 
                <input type="hidden" id="assigned-users-field" name="assigned_users" value="[]"> 

                <div>
                    <label for="name" class="block text-sm font-medium text-gray-300">Nombre de la Rutina <span class="text-red-500">*</span></label>
                    <input type="text" id="name" name="name" required 
                           class="mt-1 w-full p-3 border rounded-lg focus:ring-GYM-YELLOW focus:border-GYM-YELLOW" 
                           placeholder="Ej: Rutina B√°sico 3 D√≠as (Full Body)">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">D√≠as de Entrenamiento</label>
                    <div class="grid grid-cols-3 gap-2 text-sm">
                        <label class="inline-flex items-center text-gray-300">
                            <input type="checkbox" name="assigned_days" value="Lunes" class="day-checkbox mr-2"> Lunes
                        </label>
                        <label class="inline-flex items-center text-gray-300">
                            <input type="checkbox" name="assigned_days" value="Martes" class="day-checkbox mr-2"> Martes
                        </label>
                        <label class="inline-flex items-center text-gray-300">
                            <input type="checkbox" name="assigned_days" value="Mi√©rcoles" class="day-checkbox mr-2"> Mi√©rcoles
                        </label>
                        <label class="inline-flex items-center text-gray-300">
                            <input type="checkbox" name="assigned_days" value="Jueves" class="day-checkbox mr-2"> Jueves
                        </label>
                        <label class="inline-flex items-center text-gray-300">
                            <input type="checkbox" name="assigned_days" value="Viernes" class="day-checkbox mr-2"> Viernes
                        </label>
                        <label class="inline-flex items-center text-gray-300">
                            <input type="checkbox" name="assigned_days" value="S√°bado" class="day-checkbox mr-2"> S√°bado
                        </label>
                    </div>
                </div>


                <div>
                    <label for="description" class="block text-sm font-medium text-gray-300">Descripci√≥n de la Rutina <span class="text-red-500">*</span></label>
                    <textarea id="description" name="description" rows="4" required
                              class="mt-1 w-full p-3 border rounded-lg focus:ring-GYM-YELLOW focus:border-GYM-YELLOW" 
                              placeholder="Describe el objetivo y nivel de esta rutina. (Se guardar√° como 'notes')"></textarea>
                </div>

                <div class="text-sm text-gray-500 p-3 border border-gray-700 rounded-lg">
                    <p class="font-semibold text-gray-300">Nota:</p>
                    <p>La gesti√≥n de **Ejercicios** y **Usuarios Asignados** se mantiene en segundo plano. Para construir una rutina detallada, se requerir√° una p√°gina de "Constructor de Rutinas" separada.</p>
                </div>


                <div class="pt-6 flex justify-end space-x-3 border-t border-gray-700">
                    <button type="button" id="cancel-modal-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg transition duration-200 ease-in-out" onclick="document.getElementById('routine-modal').classList.add('hidden')">
                        Cancelar
                    </button>
                    <button type="submit" id="submit-btn" class="bg-GYM-YELLOW hover:bg-GYM-YELLOW-dark text-black font-bold py-2 px-5 rounded-lg transition duration-200 ease-in-out">
                        Crear Rutina
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // =============================================================
        // üö® URL BASE DE LA API 
        // =============================================================
        const API_BASE_URL = 'https://sijj2003.pythonanywhere.com/api/admin/routine'; 

        // Variable para almacenar la lista completa de rutinas
        let allRoutinesData = [];
        const dayNames = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];

        // =============================================================
        // L√ìGICA DE LA TABLA (READ - Leer y Mostrar)
        // =============================================================

        async function fetchAllRoutines() {
            // ... (Funci√≥n fetchAllRoutines sin cambios significativos)
            const tableBody = document.getElementById('routines-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 GYM-YELLOW">Cargando rutinas...</td></tr>';
            
            try {
                // Se usa la ruta plural /api/admin/routines
                const response = await fetch(API_BASE_URL.replace('/routine', '/routines'), { 
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error HTTP: ${response.status} - ${errorText.substring(0, 100)}...`);
                }

                const data = await response.json();
                
                if (data.success && data.routines) {
                    allRoutinesData = data.routines; 
                    renderRoutinesTable(allRoutinesData);
                } else {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-400">Error al cargar: ${data.error || 'Desconocido'}</td></tr>`;
                    allRoutinesData = [];
                }

            } catch (error) {
                console.error("Error de red al obtener rutinas:", error);
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-400">Error de conexi√≥n.</td></tr>';
                allRoutinesData = [];
            }
        }

        // Funci√≥n para renderizar la tabla con una lista de rutinas
        function renderRoutinesTable(routinesToRender) {
            const tableBody = document.getElementById('routines-table-body');
            tableBody.innerHTML = ''; 

            if (routinesToRender.length === 0) {
                const searchTerm = document.getElementById('routine-search-input').value;
                const message = searchTerm.trim() !== '' 
                    ? `No se encontraron rutinas para "${searchTerm}".` 
                    : 'No hay rutinas registradas.';

                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-400">${message}</td></tr>`;
                return;
            }

            routinesToRender.forEach(routine => {
                const row = tableBody.insertRow();
                row.classList.add('hover:bg-gray-800/50'); 
                
                // Celdas de informaci√≥n
                row.insertCell().textContent = routine.name || 'N/A';
                
                // D√≠as Asignados
                const assignedDays = routine.assigned_days && routine.assigned_days.length > 0
                    ? routine.assigned_days.join(', ')
                    : 'Ninguno';
                row.insertCell().textContent = assignedDays;


                // Descripci√≥n (limitada)
                const descriptionText = routine.description || routine.notes || 'N/A'; // Usa 'description' o 'notes'
                row.insertCell().textContent = descriptionText.length > 50 ? descriptionText.substring(0, 50) + '...' : descriptionText;


                // Celda de Acciones
                const actionsCell = row.insertCell();
                actionsCell.classList.add('space-x-2');
                
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Editar';
                editBtn.classList.add('GYM-YELLOW', 'hover:text-yellow-400', 'font-semibold');
                editBtn.onclick = () => openModalForEdit(routine);
                actionsCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Eliminar';
                deleteBtn.classList.add('text-red-500', 'hover:text-red-400', 'font-semibold', 'ml-2');
                deleteBtn.onclick = () => deleteRoutine(routine.id, routine.name);
                actionsCell.appendChild(deleteBtn);
            });
        }

        // =============================================================
        // L√ìGICA DEL MODAL (CREATE/UPDATE - Crear/Actualizar)
        // =============================================================
        
        // Helper para resetear las casillas de los d√≠as
        function resetDaysCheckboxes() {
            document.querySelectorAll('input[name="assigned_days"]').forEach(cb => {
                cb.checked = false;
            });
        }
        // Helper para obtener la rutina completa (del array local)
        function findRoutineById(id) {
            return allRoutinesData.find(r => r.id === id);
        }

        function openModalForCreate() {
            const form = document.getElementById('routine-form');
            form.reset(); 
            document.getElementById('modal-title').textContent = 'A√±adir Nueva Rutina Base';
            document.getElementById('routine-id-field').value = '';
            document.getElementById('is-edit-mode').value = 'false';
            document.getElementById('submit-btn').textContent = 'Crear Rutina';
            
            // Inicializar arrays complejos vac√≠os para nueva creaci√≥n
            document.getElementById('exercises-field').value = '[]';
            document.getElementById('assigned-users-field').value = '[]';
            resetDaysCheckboxes();

            document.getElementById('routine-modal').classList.remove('hidden');
        }

        function openModalForEdit(simplifiedRoutine) {
            const fullRoutine = findRoutineById(simplifiedRoutine.id);
            if (!fullRoutine) {
                alert("Error: No se encontr√≥ la informaci√≥n completa de la rutina.");
                return;
            }

            const form = document.getElementById('routine-form');
            form.reset(); 
            
            document.getElementById('modal-title').textContent = `Editar Rutina: ${fullRoutine.name}`;
            document.getElementById('routine-id-field').value = fullRoutine.id;
            document.getElementById('is-edit-mode').value = 'true';
            document.getElementById('submit-btn').textContent = 'Guardar Cambios';

            // Llenar campos simples
            document.getElementById('name').value = fullRoutine.name || '';
            document.getElementById('description').value = fullRoutine.description || fullRoutine.notes || ''; // Usar 'description' o 'notes'

            // 1. D√≠as Asignados (assigned_days)
            resetDaysCheckboxes();
            const days = fullRoutine.assigned_days || [];
            document.querySelectorAll('input[name="assigned_days"]').forEach(cb => {
                if (days.includes(cb.value)) {
                    cb.checked = true;
                }
            });

            // 2. Preservar Ejercicios y Usuarios (Datos complejos)
            document.getElementById('exercises-field').value = JSON.stringify(fullRoutine.exercises || []);
            document.getElementById('assigned-users-field').value = JSON.stringify(fullRoutine.assigned_users || []);


            document.getElementById('routine-modal').classList.remove('hidden');
        }

        // Manejador del Formulario (Crear y Editar)
        async function handleRoutineFormSubmit(event) {
            event.preventDefault();

            const form = event.target;
            const isEditMode = document.getElementById('is-edit-mode').value === 'true';
            const routineId = document.getElementById('routine-id-field').value;

            // 1. Recoger D√≠as Asignados
            const selectedDays = Array.from(document.querySelectorAll('input[name="assigned_days"]:checked')).map(cb => cb.value);

            // 2. Recoger datos simples
            const baseData = {
                name: form.name.value.trim(),
                description: form.description.value.trim(), // Mapeado a 'notes' en el backend
                assigned_days: selectedDays
            };
            
            // Validaciones b√°sicas
            if (!baseData.name || !baseData.description) {
                alert("El Nombre y la Descripci√≥n de la rutina son obligatorios.");
                return;
            }

            // 3. Obtener/Preservar datos complejos para el payload
            const complexData = {
                exercises: JSON.parse(document.getElementById('exercises-field').value || '[]'),
                assigned_users: JSON.parse(document.getElementById('assigned-users-field').value || '[]')
            };

            const payload = {
                ...baseData,
                ...complexData
            };
            
            const method = isEditMode ? 'PUT' : 'POST';
            const url = isEditMode ? `${API_BASE_URL}/${routineId}` : API_BASE_URL;
            const actionText = isEditMode ? 'Edici√≥n' : 'Creaci√≥n';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) // Env√≠a el objeto completo
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    const errorMessage = errorText.includes('error') ? JSON.parse(errorText).error : errorText.substring(0, 150) + '...';
                    throw new Error(`Error HTTP: ${response.status} - ${errorMessage}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    alert(`${actionText} de rutina exitosa: ${data.message}`);
                    document.getElementById('routine-modal').classList.add('hidden');
                    fetchAllRoutines(); // Recargar la tabla
                } else {
                    alert(`Error al ${actionText.toLowerCase()} rutina: ${data.error}`);
                }
            } catch (error) {
                alert(`Error de red al procesar la rutina: ${error.message}`);
                console.error(error);
            }
        }
        
        // =============================================================
        // L√ìGICA DE ELIMINACI√ìN (DELETE) y B√öSQUEDA
        // =============================================================
        // Las funciones deleteRoutine y filterRoutinesTable no necesitan cambios.
        async function deleteRoutine(routineId, routineName) {
            if (!confirm(`¬øEst√° seguro de que desea ELIMINAR permanentemente la rutina: "${routineName}"? Esta acci√≥n es irreversible.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/${routineId}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error HTTP: ${response.status} - ${errorText.substring(0, 100)}...`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Rutina "${routineName}" eliminada con √©xito!`);
                    fetchAllRoutines();
                } else {
                    alert(`Error al eliminar: ${data.error}`);
                }
            } catch (error) {
                alert(`Error de red al eliminar la rutina.`);
            }
        }

        function filterRoutinesTable(searchTerm) {
            const normalizedSearch = searchTerm.toLowerCase().trim();
            const filteredRoutines = allRoutinesData.filter(routine => {
                const name = (routine.name || '').toLowerCase();
                const description = (routine.description || routine.notes || '').toLowerCase();
                return name.includes(normalizedSearch) || description.includes(normalizedSearch);
            });
            renderRoutinesTable(filteredRoutines);
        }
        
        // =============================================================
        // üö© L√ìGICA DE NAVEGACI√ìN (REGRESAR) y INICIALIZACI√ìN üö©
        // =============================================================

        function handleNavigateBack() {
            window.location.href = 'admin_routines.html'; 
        }


        window.onload = function() {
            const storedSession = localStorage.getItem('adminSession');
            
            if (!storedSession) {
                window.location.href = 'administration.html'; 
                return;
            }

            fetchAllRoutines();

            // LISTENERS GLOBALES
            document.getElementById('back-btn').addEventListener('click', handleNavigateBack);
            document.getElementById('add-routine-btn').addEventListener('click', openModalForCreate);
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                document.getElementById('routine-modal').classList.add('hidden');
            });
            document.getElementById('routine-form').addEventListener('submit', handleRoutineFormSubmit);
            
            const routineSearchInput = document.getElementById('routine-search-input');
            if (routineSearchInput) {
                routineSearchInput.addEventListener('input', (event) => {
                    filterRoutinesTable(event.target.value);
                });
            }
        };
    </script>
</body>
</html>
