<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GYMENEZ - Gesti√≥n de Rutinas</title>
    <link rel="icon" type="image/png" href="mini_logo.png">
    <link rel="shortcut icon" type="image/png" href="mini_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /*
         * ESTILOS BASE COPIADOS DE admin_users.html
         */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .GYM-YELLOW { color: #FFC300; }
        .bg-GYM-YELLOW { background-color: #FFC300; }
        .hover\:bg-GYM-YELLOW-dark:hover { background-color: #FFB300; }
        .border-GYM-YELLOW { border-color: #FFC300; }
        .focus\:ring-GYM-YELLOW:focus { --tw-ring-color: #FFC300; }
        .focus\:border-GYM-YELLOW:focus { border-color: #FFC300; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a;
            background-image: url('FONDO.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #e5e7eb;
            min-height: 100vh;
        }

        .dashboard-header {
            background-color: rgba(13, 13, 26, 0.9);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .content-container {
            background-color: rgba(18, 18, 30, 0.95);
            backdrop-filter: blur(3px);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            padding: 24px;
            margin-top: 24px;
        }

        .admin-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .admin-table th, .admin-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-table th {
            background-color: #1a1a2e;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.85); }
        /* üö® MODAL M√ÅS GRANDE */
        .modal-content {
            background-color: #1a1a2e;
            border: 1px solid #334155;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        .modal-content input[type="text"], .modal-content textarea, .modal-content input[type="number"] {
             background-color: #1a1a2e;
             border: 1px solid #334155;
             color: #e5e7eb;
        }
        /* Estilo para las casillas de verificaci√≥n */
        .day-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #334155;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s ease;
            vertical-align: middle;
        }
        .day-checkbox:checked {
            background-color: #FFC300;
            border-color: #FFC300;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='black' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        /* Estilos para el constructor */
        .panel-builder {
            background-color: #1a1a2e;
            border-radius: 8px;
            border: 1px solid #334155;
            min-height: 250px;
        }
        .list-item-hover:hover {
            background-color: #334155;
        }
    </style>
</head>
<body>
    
    <header class="dashboard-header">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">
                <span class="GYM-YELLOW">GYM</span>ENEZ
            </h1>
            <nav class="space-x-4">
                <button id="back-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                    ‚Üê Regresar
                </button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">
        <div class="content-container mt-8">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3">
                <h2 class="text-xl font-semibold text-white">Lista de Rutinas Base</h2>
                <button id="add-routine-btn" class="bg-GYM-YELLOW hover:bg-GYM-YELLOW-dark text-black font-semibold py-2 px-4 rounded-lg text-sm transition duration-150 ease-in-out">
                    + A√±adir Rutina Base
                </button>
            </div>
            
            <div class="mb-6">
                <input type="text" id="routine-search-input" placeholder="Buscar por Nombre o Descripci√≥n..." 
                       class="w-full p-3 rounded-lg bg-[#1a1a2e] border border-gray-700 text-gray-300 placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-GYM-YELLOW focus:border-GYM-YELLOW transition duration-150">
            </div>

            <div class="overflow-x-auto rounded-lg border border-gray-700">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th class="rounded-tl-lg">Nombre de la Rutina</th>
                            <th>D√≠as Asignados</th>
                            <th># Ejercicios</th>
                            <th># Usuarios</th>
                            <th class="rounded-tr-lg">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="routines-table-body" class="text-sm text-gray-300 divide-y divide-gray-800">
                        </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="routine-modal" class="fixed inset-0 bg-black bg-opacity-80 modal-backdrop hidden z-[1010] flex justify-center p-4 overflow-y-auto">
        
        <div class="modal-content w-full max-w-4xl p-6 rounded-xl transform transition-all duration-300 scale-100">
            
            <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-6">
                <h3 id="modal-title" class="text-2xl font-semibold text-white">A√±adir Nueva Rutina Base</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-GYM-YELLOW text-3xl leading-none transition-colors duration-200">&times;</button>
            </div>

            <form id="routine-form" class="space-y-6">
                <input type="hidden" id="routine-id-field" name="id">
                <input type="hidden" id="is-edit-mode" value="false">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-6">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-300">Nombre de la Rutina <span class="text-red-500">*</span></label>
                            <input type="text" id="name" name="name" required 
                                class="mt-1 w-full p-3 border rounded-lg focus:ring-GYM-YELLOW focus:border-GYM-YELLOW" 
                                placeholder="Ej: Rutina B√°sico 3 D√≠as (Full Body)">
                        </div>

                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-300">Descripci√≥n de la Rutina <span class="text-red-500">*</span></label>
                            <textarea id="description" name="description" rows="4" required
                                class="mt-1 w-full p-3 border rounded-lg focus:ring-GYM-YELLOW focus:border-GYM-YELLOW" 
                                placeholder="Describe el objetivo y nivel de esta rutina. (Se guardar√° como 'notes')"></textarea>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">D√≠as de Entrenamiento</label>
                        <div class="grid grid-cols-3 gap-2 text-sm panel-builder p-4">
                            <label class="inline-flex items-center text-gray-300">
                                <input type="checkbox" name="assigned_days" value="Lunes" class="day-checkbox mr-2"> Lunes
                            </label>
                            <label class="inline-flex items-center text-gray-300">
                                <input type="checkbox" name="assigned_days" value="Martes" class="day-checkbox mr-2"> Martes
                            </label>
                            <label class="inline-flex items-center text-gray-300">
                                <input type="checkbox" name="assigned_days" value="Mi√©rcoles" class="day-checkbox mr-2"> Mi√©rcoles
                            </label>
                            <label class="inline-flex items-center text-gray-300">
                                <input type="checkbox" name="assigned_days" value="Jueves" class="day-checkbox mr-2"> Jueves
                            </label>
                            <label class="inline-flex items-center text-gray-300">
                                <input type="checkbox" name="assigned_days" value="Viernes" class="day-checkbox mr-2"> Viernes
                            </label>
                            <label class="inline-flex items-center text-gray-300">
                                <input type="checkbox" name="assigned_days" value="S√°bado" class="day-checkbox mr-2"> S√°bado
                            </label>
                        </div>
                    </div>
                </div>

                <h4 class="text-lg font-semibold text-white border-b border-gray-700 pb-2 mt-8">Asignaci√≥n de Ejercicios</h4>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="panel-builder p-4">
                        <h5 class="text-md font-medium text-gray-400 mb-3">Ejercicios para A√±adir</h5>
                        <input type="text" id="exercise-search" placeholder="Buscar ejercicio..." class="w-full p-2 mb-3 rounded-lg bg-[#0d0d1a] border border-gray-700 text-gray-300">
                        <div id="available-exercises-list" class="h-[250px] overflow-y-auto space-y-1">
                            <div class="text-gray-500 text-center py-4">Cargando ejercicios...</div>
                        </div>
                    </div>

                    <div class="panel-builder p-4">
                        <h5 class="text-md font-medium text-gray-400 mb-3 flex justify-between items-center">
                            Ejercicios Asignados
                            <span class="text-sm text-GYM-YELLOW" id="selected-exercise-count">0 Ejercicios</span>
                        </h5>
                        <div id="routine-exercises-list" class="h-[280px] overflow-y-auto space-y-3 p-1">
                            <div class="text-gray-500 text-center py-4">A√±ade ejercicios desde el panel izquierdo.</div>
                        </div>
                    </div>
                </div>
                
                <h4 class="text-lg font-semibold text-white border-b border-gray-700 pb-2 mt-8">Asignaci√≥n de Usuarios</h4>
                <div class="panel-builder p-4">
                    <h5 class="text-md font-medium text-gray-400 mb-3">Usuarios Asignados (<span id="assigned-user-count">0</span>)</h5>
                    <input type="text" id="user-search" placeholder="Buscar usuario (Nombre, Email)..." class="w-full p-2 mb-3 rounded-lg bg-[#0d0d1a] border border-gray-700 text-gray-300">
                    <div id="available-users-list" class="h-[150px] overflow-y-auto space-y-1 grid grid-cols-2 md:grid-cols-3 gap-2">
                        <div class="text-gray-500 text-center py-4 col-span-full">Cargando usuarios...</div>
                    </div>
                </div>


                <div class="pt-6 flex justify-end space-x-3 border-t border-gray-700">
                    <button type="button" id="cancel-modal-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-5 rounded-lg transition duration-200 ease-in-out" onclick="document.getElementById('routine-modal').classList.add('hidden')">
                        Cancelar
                    </button>
                    <button type="submit" id="submit-btn" class="bg-GYM-YELLOW hover:bg-GYM-YELLOW-dark text-black font-bold py-2 px-5 rounded-lg transition duration-200 ease-in-out">
                        Crear Rutina
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // =============================================================
        // üö® URLS DE LA API
        // =============================================================
        const API_ROUTINE_BASE = 'https://sijj2003.pythonanywhere.com/api/admin/routine'; 
        const API_EXERCISES = 'https://sijj2003.pythonanywhere.com/api/admin/exercises';
        const API_USERS = 'https://sijj2003.pythonanywhere.com/api/admin/users';

        let allRoutinesData = [];
        let allAvailableExercises = [];
        let allAvailableUsers = [];
        
        // Objeto que mantendr√° los datos de la rutina que se est√° editando/creando
        // Esto es crucial para mantener los arrays complejos en memoria
        let currentRoutineState = {
            id: null,
            name: '',
            description: '',
            assigned_days: [],
            exercises: [],
            assigned_users: []
        };
        
        // =============================================================
        // L√ìGICA DE CARGA DE DATOS INICIAL
        // =============================================================

        async function fetchAllDataInitial() {
            // 1. Fetch de Rutinas
            const routinesPromise = fetch(API_ROUTINE_BASE.replace('/routine', '/routines')).then(r => r.json());
            
            // 2. Fetch de Ejercicios
            const exercisesPromise = fetch(API_EXERCISES).then(r => r.json());
            
            // 3. Fetch de Usuarios
            const usersPromise = fetch(API_USERS).then(r => r.json());

            try {
                const [routinesData, exercisesData, usersData] = await Promise.all([
                    routinesPromise, 
                    exercisesPromise, 
                    usersPromise
                ]);

                allRoutinesData = routinesData.success ? routinesData.routines : [];
                allAvailableExercises = exercisesData.success ? exercisesData.exercises : [];
                allAvailableUsers = usersData.success ? usersData.users : [];
                
                renderRoutinesTable(allRoutinesData);
            } catch (error) {
                console.error("Error de red al obtener todos los datos:", error);
                document.getElementById('routines-table-body').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-400">Error al cargar datos iniciales.</td></tr>';
            }
        }

        // =============================================================
        // L√ìGICA DE LA TABLA (READ - Leer y Mostrar)
        // =============================================================

        function renderRoutinesTable(routinesToRender) {
            const tableBody = document.getElementById('routines-table-body');
            tableBody.innerHTML = ''; 

            if (routinesToRender.length === 0) {
                const searchTerm = document.getElementById('routine-search-input').value;
                const message = searchTerm.trim() !== '' 
                    ? `No se encontraron rutinas para "${searchTerm}".` 
                    : 'No hay rutinas registradas.';

                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-400">${message}</td></tr>`;
                return;
            }

            routinesToRender.forEach(routine => {
                const row = tableBody.insertRow();
                row.classList.add('hover:bg-gray-800/50'); 
                
                // Celdas de informaci√≥n
                row.insertCell().textContent = routine.name || 'N/A';
                
                const assignedDays = (routine.assigned_days && routine.assigned_days.length > 0)
                    ? routine.assigned_days.join(', ')
                    : 'Ninguno';
                row.insertCell().textContent = assignedDays.length > 20 ? assignedDays.substring(0, 20) + '...' : assignedDays;
                
                const numExercises = (routine.exercises || []).length;
                row.insertCell().textContent = numExercises;
                
                const numUsers = (routine.assigned_users || []).length;
                row.insertCell().textContent = numUsers;


                // Celda de Acciones
                const actionsCell = row.insertCell();
                actionsCell.classList.add('space-x-2', 'whitespace-nowrap');
                
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Editar';
                editBtn.classList.add('GYM-YELLOW', 'hover:text-yellow-400', 'font-semibold', 'text-sm');
                editBtn.onclick = () => openModalForEdit(routine.id);
                actionsCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Eliminar';
                deleteBtn.classList.add('text-red-500', 'hover:text-red-400', 'font-semibold', 'ml-2', 'text-sm');
                deleteBtn.onclick = () => deleteRoutine(routine.id, routine.name);
                actionsCell.appendChild(deleteBtn);
            });
        }

        // =============================================================
        // L√ìGICA DEL MODAL (CREATE/UPDATE)
        // =============================================================
        
        function resetModalState() {
            // Limpiar el estado de la rutina actual
            currentRoutineState = {
                id: null,
                name: '',
                description: '',
                assigned_days: [],
                exercises: [],
                assigned_users: []
            };

            // Resetear el formulario y los inputs
            document.getElementById('routine-form').reset(); 
            document.getElementById('routine-id-field').value = '';
            document.getElementById('is-edit-mode').value = 'false';
            
            // Renderizar las listas vac√≠as
            renderRoutineExercises(); 
            renderAvailableExercises();
            renderAvailableUsers();
            updateSelectedExerciseCount();
            updateAssignedUserCount();
        }

        function openModalForCreate() {
            resetModalState();
            document.getElementById('modal-title').textContent = 'A√±adir Nueva Rutina Base';
            document.getElementById('submit-btn').textContent = 'Crear Rutina';

            document.getElementById('routine-modal').classList.remove('hidden');
        }

        function openModalForEdit(routineId) {
            const fullRoutine = allRoutinesData.find(r => r.id === routineId);
            if (!fullRoutine) {
                alert("Error: No se encontr√≥ la informaci√≥n completa de la rutina.");
                return;
            }

            resetModalState();
            
            // Cargar el estado de la rutina
            currentRoutineState = {
                id: fullRoutine.id,
                name: fullRoutine.name || '',
                description: fullRoutine.description || fullRoutine.notes || '',
                assigned_days: fullRoutine.assigned_days || [],
                // Clonar los arrays complejos para trabajar con ellos
                exercises: [...(fullRoutine.exercises || [])], 
                assigned_users: [...(fullRoutine.assigned_users || [])]
            };

            document.getElementById('modal-title').textContent = `Editar Rutina: ${currentRoutineState.name}`;
            document.getElementById('routine-id-field').value = currentRoutineState.id;
            document.getElementById('is-edit-mode').value = 'true';
            document.getElementById('submit-btn').textContent = 'Guardar Cambios';

            // Llenar campos simples
            document.getElementById('name').value = currentRoutineState.name;
            document.getElementById('description').value = currentRoutineState.description;

            // Llenar D√≠as Asignados
            document.querySelectorAll('input[name="assigned_days"]').forEach(cb => {
                if (currentRoutineState.assigned_days.includes(cb.value)) {
                    cb.checked = true;
                }
            });
            
            // Renderizar las secciones din√°micas
            renderRoutineExercises(); 
            renderAvailableExercises();
            renderAvailableUsers();
            updateSelectedExerciseCount();
            updateAssignedUserCount();

            document.getElementById('routine-modal').classList.remove('hidden');
        }

        // Manejador del Formulario (Crear y Editar)
async function handleRoutineFormSubmit(event) {
    event.preventDefault();

    const form = event.target;
    const isEditMode = document.getElementById('is-edit-mode').value === 'true';
    const routineId = document.getElementById('routine-id-field').value;

    // 1. Recoger D√≠as Asignados del formulario (el √∫nico campo que se toma directamente de los inputs)
    const selectedDays = Array.from(document.querySelectorAll('input[name="assigned_days"]:checked')).map(cb => cb.value);

    // 2. Construir el payload final desde el estado y los campos simples
    const payload = {
        name: form.name.value.trim(),
        description: form.description.value.trim(), // Mapeado a 'notes' en el backend
        assigned_days: selectedDays,
        
        // Arrays complejos que ya se actualizaron en el JS
        exercises: currentRoutineState.exercises,
        assigned_users: currentRoutineState.assigned_users
    };
    
    // Validaciones b√°sicas
    if (!payload.name || !payload.description) {
        alert("El Nombre y la Descripci√≥n de la rutina son obligatorios.");
        return;
    }

    const method = isEditMode ? 'PUT' : 'POST';
    const url = isEditMode ? `${API_ROUTINE_BASE}/${routineId}` : API_ROUTINE_BASE;
    const actionText = isEditMode ? 'Edici√≥n' : 'Creaci√≥n';

    document.getElementById('submit-btn').textContent = 'Guardando...';
    document.getElementById('submit-btn').disabled = true;

    try {
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            let errorMessage;
            try {
                // Intenta parsear como JSON si el texto contiene 'error'
                errorMessage = errorText.includes('error') ? JSON.parse(errorText).error : errorText.substring(0, 150) + '...';
            } catch {
                errorMessage = errorText.substring(0, 150) + '...';
            }
            throw new Error(`Error HTTP: ${response.status} - ${errorMessage}`);
        }

        const data = await response.json();
        
        if (data.success) {
            // üö® AJUSTE DE MENSAJE DE √âXITO
            let successMessage = `${actionText} de rutina exitosa: ${data.message}`;
            
            // A√±adir el mensaje de la desasignaci√≥n si existe
            if (isEditMode && data.message.includes('desasignados autom√°ticamente')) {
                 successMessage = `Rutina actualizada exitosamente. ¬°Atenci√≥n! Los usuarios asignados fueron **desasignados autom√°ticamente** de cualquier otra rutina base para evitar conflictos.`;
            }

            alert(successMessage);
            document.getElementById('routine-modal').classList.add('hidden');
            await fetchAllDataInitial(); // Recargar la tabla
        } else {
            alert(`Error al ${actionText.toLowerCase()} rutina: ${data.error}`);
        }
    } catch (error) {
        alert(`Error de red al procesar la rutina: ${error.message}`);
        console.error(error);
    } finally {
        document.getElementById('submit-btn').textContent = isEditMode ? 'Guardar Cambios' : 'Crear Rutina';
        document.getElementById('submit-btn').disabled = false;
    }
}
        
        // =============================================================
        // L√ìGICA DE ASIGNACI√ìN DE USUARIOS
        // =============================================================
        
        function updateAssignedUserCount() {
            const count = (currentRoutineState.assigned_users || []).length;
            document.getElementById('assigned-user-count').textContent = count;
        }

        function renderAvailableUsers(searchTerm = '') {
            const list = document.getElementById('available-users-list');
            list.innerHTML = '';
            const assignedUserIds = new Set(currentRoutineState.assigned_users || []);
            const normalizedSearch = searchTerm.toLowerCase().trim();

            const filteredUsers = allAvailableUsers.filter(user => {
                const name = (user.name || '').toLowerCase();
                const email = (user.email || '').toLowerCase();
                return name.includes(normalizedSearch) || email.includes(normalizedSearch);
            }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            if (filteredUsers.length === 0) {
                list.innerHTML = `<div class="text-gray-500 text-center py-4 col-span-full">No se encontraron usuarios.</div>`;
                return;
            }

            filteredUsers.forEach(user => {
                const isAssigned = assignedUserIds.has(user.id);
                const item = document.createElement('label');
                item.classList.add('inline-flex', 'items-center', 'text-sm', 'text-gray-300', 'p-2', 'list-item-hover', 'rounded-md', isAssigned ? 'bg-green-700/50' : 'bg-transparent');
                item.innerHTML = `
                    <input type="checkbox" data-user-id="${user.id}" 
                           class="w-4 h-4 text-GYM-YELLOW bg-gray-600 border-gray-500 rounded focus:ring-GYM-YELLOW" 
                           ${isAssigned ? 'checked' : ''}
                           onchange="toggleUserAssignment('${user.id}')">
                    <span class="ml-2 truncate" title="${user.name || user.email || 'Usuario sin nombre'}">${user.name || user.email || 'N/A'}</span>
                `;
                list.appendChild(item);
            });
        }

        function toggleUserAssignment(userId) {
            let assignedUsers = currentRoutineState.assigned_users || [];
            
            if (assignedUsers.includes(userId)) {
                currentRoutineState.assigned_users = assignedUsers.filter(id => id !== userId);
            } else {
                currentRoutineState.assigned_users.push(userId);
            }
            updateAssignedUserCount();
            renderAvailableUsers(document.getElementById('user-search').value);
        }

        // =============================================================
        // L√ìGICA DE ASIGNACI√ìN Y CONFIGURACI√ìN DE EJERCICIOS
        // =============================================================

        function updateSelectedExerciseCount() {
            const count = (currentRoutineState.exercises || []).length;
            document.getElementById('selected-exercise-count').textContent = `${count} Ejercicios`;
        }
        
        function renderAvailableExercises(searchTerm = '') {
            const list = document.getElementById('available-exercises-list');
            list.innerHTML = '';
            const assignedExerciseIds = new Set((currentRoutineState.exercises || []).map(e => e.exercise_id));
            const normalizedSearch = searchTerm.toLowerCase().trim();

            const filteredExercises = allAvailableExercises.filter(exercise => {
                const name = (exercise.name || '').toLowerCase();
                const description = (exercise.description || '').toLowerCase();
                return name.includes(normalizedSearch) || description.includes(normalizedSearch);
            }).sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            if (filteredExercises.length === 0) {
                list.innerHTML = `<div class="text-gray-500 text-center py-4">No se encontraron ejercicios.</div>`;
                return;
            }

            filteredExercises.forEach(exercise => {
                const isAssigned = assignedExerciseIds.has(exercise.id);
                const item = document.createElement('div');
                item.classList.add('p-3', 'rounded-md', 'flex', 'justify-between', 'items-center', 'text-sm', 'list-item-hover', isAssigned ? 'bg-GYM-YELLOW/20' : 'bg-[#25253e]');
                item.innerHTML = `
                    <span class="${isAssigned ? 'text-GYM-YELLOW font-semibold' : 'text-gray-300'}">${exercise.name}</span>
                    <button class="${isAssigned ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-black text-xs font-bold py-1 px-3 rounded"
                            onclick="toggleExerciseAssignment('${exercise.id}', '${exercise.name.replace(/'/g, "\\'")}', ${isAssigned})">
                        ${isAssigned ? 'Quitar' : 'A√±adir'}
                    </button>
                `;
                list.appendChild(item);
            });
        }
        
        function renderRoutineExercises() {
            const list = document.getElementById('routine-exercises-list');
            list.innerHTML = '';
            
            if ((currentRoutineState.exercises || []).length === 0) {
                list.innerHTML = `<div class="text-gray-500 text-center py-4">A√±ade ejercicios desde el panel izquierdo.</div>`;
                return;
            }

            currentRoutineState.exercises.forEach((exercise, index) => {
                const item = document.createElement('div');
                item.classList.add('bg-[#1a1a2e]', 'p-3', 'rounded-lg', 'border', 'border-gray-700', 'space-y-3');
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-base font-bold text-GYM-YELLOW">${index + 1}. ${exercise.exercise_name}</span>
                        <button class="text-red-400 hover:text-red-600 text-xl leading-none" onclick="toggleExerciseAssignment('${exercise.exercise_id}', '${exercise.exercise_name.replace(/'/g, "\\'")}', true)">&times;</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <label class="block text-xs font-medium text-gray-400">Series (Sets)</label>
                            <input type="number" min="1" value="${exercise.sets || 3}" 
                                   onchange="updateExerciseDetail('${exercise.exercise_id}', 'sets', this.value)"
                                   class="mt-1 w-full p-2 rounded-lg bg-[#0d0d1a] border border-gray-600 text-white focus:ring-GYM-YELLOW focus:border-GYM-YELLOW">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-400">Repeticiones</label>
                            <input type="number" min="1" value="${exercise.repetitions || 10}" 
                                   onchange="updateExerciseDetail('${exercise.exercise_id}', 'repetitions', this.value)"
                                   class="mt-1 w-full p-2 rounded-lg bg-[#0d0d1a] border border-gray-600 text-white focus:ring-GYM-YELLOW focus:border-GYM-YELLOW">
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        function toggleExerciseAssignment(exerciseId, exerciseName, isAssigned) {
            if (!currentRoutineState.exercises) currentRoutineState.exercises = [];

            if (isAssigned) {
                // Quitar
                currentRoutineState.exercises = currentRoutineState.exercises.filter(e => e.exercise_id !== exerciseId);
            } else {
                // A√±adir con valores por defecto
                currentRoutineState.exercises.push({
                    exercise_id: exerciseId,
                    exercise_name: exerciseName,
                    sets: 3, 
                    repetitions: 10
                });
            }

            // Re-renderizar ambos paneles
            renderAvailableExercises(document.getElementById('exercise-search').value);
            renderRoutineExercises();
            updateSelectedExerciseCount();
        }

        function updateExerciseDetail(exerciseId, field, value) {
            const index = currentRoutineState.exercises.findIndex(e => e.exercise_id === exerciseId);
            if (index > -1) {
                // Asegurar que sea un n√∫mero (o 0 si no es v√°lido)
                currentRoutineState.exercises[index][field] = parseInt(value) > 0 ? parseInt(value) : 1; 
                renderRoutineExercises(); // Opcional: Re-renderizar para reflejar el cambio o reordenar si se implementa.
            }
        }
        
        // =============================================================
        // L√ìGICA DE ELIMINACI√ìN (DELETE) Y B√öSQUEDA
        // =============================================================
        
        async function deleteRoutine(routineId, routineName) {
            if (!confirm(`¬øEst√° seguro de que desea ELIMINAR permanentemente la rutina: "${routineName}"? Esta acci√≥n es irreversible.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_ROUTINE_BASE}/${routineId}`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
                if (!response.ok) { throw new Error(`Error HTTP: ${response.status}`); }
                const data = await response.json();
                
                if (data.success) {
                    alert(`Rutina "${routineName}" eliminada con √©xito!`);
                    await fetchAllDataInitial();
                } else {
                    alert(`Error al eliminar: ${data.error}`);
                }
            } catch (error) {
                alert(`Error de red al eliminar la rutina.`);
            }
        }

        function filterRoutinesTable(searchTerm) {
            const normalizedSearch = searchTerm.toLowerCase().trim();
            const filteredRoutines = allRoutinesData.filter(routine => {
                const name = (routine.name || '').toLowerCase();
                const description = (routine.description || routine.notes || '').toLowerCase();
                return name.includes(normalizedSearch) || description.includes(normalizedSearch);
            });
            renderRoutinesTable(filteredRoutines);
        }
        
        function handleNavigateBack() { window.location.href = 'admin_routines.html'; }


        // --- INICIALIZACI√ìN ---
        window.onload = function() {
            const storedSession = localStorage.getItem('adminSession');
            
            if (!storedSession) {
                window.location.href = 'administration.html'; 
                return;
            }

            fetchAllDataInitial();

            // LISTENERS GLOBALES
            document.getElementById('back-btn').addEventListener('click', handleNavigateBack);
            document.getElementById('add-routine-btn').addEventListener('click', openModalForCreate);
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                document.getElementById('routine-modal').classList.add('hidden');
            });
            document.getElementById('routine-form').addEventListener('submit', handleRoutineFormSubmit);
            
            document.getElementById('routine-search-input').addEventListener('input', (event) => { 
                filterRoutinesTable(event.target.value);
            });
            
            // Listeners dentro del Modal para b√∫squeda de Ejercicios y Usuarios
            document.getElementById('exercise-search').addEventListener('input', (event) => {
                renderAvailableExercises(event.target.value);
            });
            document.getElementById('user-search').addEventListener('input', (event) => {
                renderAvailableUsers(event.target.value);
            });
        };
    </script>
</body>
</html>
